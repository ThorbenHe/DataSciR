---
title: "Project Notebook"
author: "Kiran Babu Thatha, Marcel Schulte, Obinna Patrick Nkwocha, Shweta Pandey, Thorben Hebbelmann"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true
    toc_float: true
---

```{r setup, include=FALSE}
#chooseCRANmirror(graphics=FALSE, ind=1)
knitr::opts_chunk$set(echo = FALSE, cache = TRUE)

library(psych)
library(tidyverse)
library(ggthemes)
library(dplyr)
library(extrafont)
library(RColorBrewer)
library(plotly)
library(tidymodels)
library(countrycode)
library(kableExtra)
library(ppsr)
library(patchwork)
library(gganimate)
library(mice)
library(stringr)
library(rworldmap)
library(data.table)
library(gifski)


# set theme
#theme_set(
#  theme_minimal(base_size = 18) +
#    theme(plot.title = element_text(size = rel(1.05)))
#)

options(scipen=999)
```

# Overview & Motivation

The existence of forests is essential for our life on Earth. By covering around 31 percent of the world’s total land area, forests provide a retreat and home to over 80 percent of land animals and countless partially even undiscovered plants. One can say that forests are the backbone of entire ecosystems. A significant part of the oxygen we breathe is provided by the trees, while they also absorb about 25 percent of greenhouse gases. Also economically we are dependent on forests as about 1.6 billion people around the world earn their livelihoods with forests. Furthermore, forests provide 40 percent of today’s global renewable energy supply, as much as solar, hydroelectric and wind power combined.
Despite these utilities, forestation across the world has faced several challenges ranging from wildfire, human-driven deforestation, poor management and poor conversation in general. However, a loss of whole forests would mean severe consequences to humanity and life on Earth.  

With this project we seek to answer important questions that address these challenges. We want to figure out the causes of destruction of forests, highlight their importance to our environment and predict trends around reforestation/deforestation. Moreover, we hope to show how we can tackle climate change by reforestation, in particular, how an increase in the forest’s area will help to increase the buffer of sustainability.
For the statistics so far, see our [reference](https://unece.org/forestry/news/10-facts-fall-love-forests#:~:text=1) (Opened on 07th of May, 2021).

# Global Forest Development

### This part of our project answers the following questions:

* What was the global forest development over the last 30 years? 
  + What are the trends? (globally)
* Is there a correlation between air pollution and the amount of forest in a country / globally?
  + Which countries have the most air pollution?
  
### Overview and preprocessing of the available data

The first data set is about the forest cover of the continents.
[Forest land of continents](http://www.fao.org/faostat/en/#data/GF)


First we preprocess the data set, we change the names of te columns we later need and make them more readable

* The 'Value' column has been change to ForestSize to make it more understandable
* The 'Area' column has been renamed as Continent to give more meaningful information 


```{r read-dataset, echo=FALSE}
# forest cover of continents dataset
forest_continents <- read_csv("FAOSTAT_data_continents.csv")

# change column names
colnames(forest_continents)[colnames(forest_continents) == "Value"] <- "ForestSize"
colnames(forest_continents)[colnames(forest_continents) == "Area"] <- "Continent"

forest_continents

```


```{r structure-and-dimension-of-data, echo=FALSE}
str(forest_continents)
dim(forest_continents)
```
Here we have pre-processed out data set

* We have imputed the missing values by dropping them 

```{r data-wrangling, echo=FALSE}
newData <- forest_continents %>%
  drop_na() %>% 
  select(c("Continent","Year","ForestSize")) %>% 
  group_by(Continent, Year) %>% 
  arrange(Year) %>% 
  mutate(AvgforestSize = mean(ForestSize))

newData

```



## Global Forest Trend

+ Plot showing the forest cover of the continents
+ the plot shows that the forest cover of the continents has decreased in the last 30 years


```{r forest-continents-scatter-plot, echo=FALSE}
newData  %>% 
  ggplot(aes(x = Year, y = ForestSize)) +
  geom_point(aes(color = Continent), size = 3, shape = 16, alpha = 0.7) +
  scale_y_continuous(limits = c(100000, 1800000))+
  labs(
    x = "Years",
    y = "Forest land(1000ha)",
    title = "Global Forest Land through the decades"
  ) +
  theme_minimal()+
  scale_y_continuous(labels = scales::comma)

```
### Findings:
+ Forest land has decreased globally


```{r Load-Country-data, echo=FALSE}
forest_countries <- read_csv("FAOSTAT_data_6-9-2021.csv")

colnames(forest_countries)[colnames(forest_countries) == "Value"] <- "ForestArea"
colnames(forest_countries)[colnames(forest_countries) == "Area"] <- "Country"
forest_countries <- forest_countries %>% subset(Country != "USSR")
forest_countries <- forest_countries %>% subset(Country != "China, mainland")

glimpse(forest_countries)
```


## Top 20 countries with largest forest area


```{r top-20-countries-with-largest-forest-area-plot, echo=FALSE}

forest_countries %>% 
  drop_na() %>% 
  group_by(Country) %>% 
  summarize(avg_forest_size = mean(ForestArea)) %>% 
  as.data.frame() %>% 
  ungroup() %>% 
  arrange(desc(avg_forest_size)) %>%
  top_n(20) %>% 
  ggplot(aes(x = avg_forest_size, y = reorder(Country, avg_forest_size))) +
  geom_col(fill = "#1c9099") +
  theme(legend.position = "none") +
  labs(
    x = "Average Forest Size (1000ha)",
    y = "Country",
    title = "Top 10 countries with largest forest area",
    subtitle = "Time period: 1990 - 2020"
  )+
  scale_x_continuous(labels = scales::comma) +
  theme_minimal()+
  theme(axis.title.x = element_text(color = "Black"), text = element_text(family="Arial")) 
 
```
### Findings
+ Russian federation has the largest forest cover in the last 30 years



```{r preprocessing-country-data, echo=FALSE}
forest_countries %>%
  drop_na() %>%
  group_by(Country, Year) %>% 
  summarize(forest_perYear = sum(ForestArea)/Year)#### do this with air pollution per year

```


## Countries With least forest area


```{r countries-with-least-forest-area-plot, echo=FALSE}

forest_countries %>% 
  drop_na() %>% 
  group_by(Country) %>% 
  summarize(avg_forest_size = mean(ForestArea)) %>% 
  as.data.frame() %>% 
  arrange(desc(avg_forest_size)) %>%
  top_n(-20) %>% 
  ggplot(aes(x = avg_forest_size, y = reorder(Country, -avg_forest_size), fill = Country)) +
  geom_col(fill = "#756bb1") +
  theme(legend.position = "none") +
  labs(
    x = "Average Forest Size (1000ha)",
    y = "Country",
    title = "Countries with least forest area",
    subtitle = "Time period: 1990 - 2020"
  )+
  theme_minimal()+
  theme(axis.title.x = element_text(color = "Black"), text = element_text(family="Arial"))
  
```
### Findings
+ Curacao has show the least forest cover in the last 30 years



The air pollution data has air quality value in microgram cubic metre from the year 1990 to 2019. However, a few years \n data is not available.
Air quality shows changes in the amount of pollution in the air. 

```{r air-pollution-data, echo=FALSE}

AirPollution <- read_csv("EXP_PM2_Air_Quality.csv")
colnames(AirPollution)[colnames(AirPollution) == "Value"] <- "AirPollution"
glimpse(AirPollution)

AirPollution <- AirPollution %>% 
  select(c("Country", "Year","AirPollution")) %>% 
  group_by(Country,Year) %>% 
  glimpse()

```

```{r merged-data-set, echo=FALSE}
mergedData <- merge(forest_countries, AirPollution, by=c("Country","Year")) %>%
  select(c('Country','Year','ForestArea','AirPollution')) %>% 
  drop_na() %>% 
  group_by(Year) %>% 
  summarize(TotalForestArea = sum(ForestArea), TotalAirPollution = sum(AirPollution)) %>% 
  ungroup() %>% 
  unique()
mergedData

```
## Is there a correlation between Forest area and air pollution?

```{r correlation-plots, echo=FALSE}
mergedData %>% 
  ggplot(aes(x = TotalForestArea, y = TotalAirPollution)) +
  geom_point(size = 4, alpha=0.7, color = "#056b5f") +
  geom_line(size=1, alpha=0.5, color="#056b5f")+
  labs(x="Total Forest Area (1000ha)", y = "Total Air Pollution", title="Correlation between Forest Area and Air Pollution (globally)") + 
  geom_smooth(method = 'lm')+
  scale_x_continuous(labels = scales::comma)+
  scale_y_continuous(labels = scales::comma)
```
Findings:
No linear relationship between Forest Area and Air Pollution



## Correlation Value
```{r correlation2, echo=FALSE}
corr <- cor(x = mergedData$TotalForestArea, y = mergedData$TotalAirPollution, use = "everything", method = "kendall")
paste("Kendall = ", corr)

```
Findings:
A negative correlation coefficient shows the variables are moving in the opposite direction.

## Regression Analysis

```{r regression, echo=FALSE}
# merge  data sets and remove missing values

data <-  merge(forest_countries,AirPollution,by=c("Country","Year")) %>%
  drop_na() %>% 
  select(c("Country","Year","ForestArea","AirPollution"))
 
```

## fit model and estimate parameters

```{r build-model, echo=FALSE}
linear_reg() %>%
  set_engine("lm") %>%
  fit(formula = ForestArea ~ AirPollution, data = data) -> model
model

```
Findings:


## extrapolation
```{r tidy, echo=FALSE}
fit <- linear_reg() %>%
  set_engine("lm") %>%
  fit(formula = ForestArea ~ AirPollution, data = data) 

fit %>% tidy()
```
Findings:
Very low p-value signifies that Forest Area and Air Pollution are independent of each other.

## Residual Plot

```{r residual-plot-Air-Pollution, echo=FALSE}
augment(fit$fit) %>%
  ggplot(aes(x = ForestArea, y = AirPollution)) +
  geom_point(aes(color=.resid)) +
  geom_smooth(method = "lm") +
  scale_color_gradient2(mid = "gray80") +
  labs(title = "Residual",
       x = "Forest Area (1000ha)", 
       y = "AirPollution(Micrograms per cubic metre)", color = "Residuals") +
  scale_y_continuous(labels = scales::comma)
```
Finding:

* As our data set is non-linearly associated, the residual plot here assesses the appropriateness of our linear regression

* In the plot the residual of data points are away from zero show the model is not a good fit



### For more reliable results of the relationship between Forest Area and Air Pollution,\n
we implement Predictive Power Score

```{r air-pollution, echo=FALSE}

library(ppsr)
pps1 <- score_df(data %>% 
                   group_by(Year) %>% 
                   summarise(AirPollution = sum(AirPollution, na.rm = TRUE), 
                             ForestArea = sum(ForestArea)) %>% ungroup() %>% 
                   select(AirPollution, ForestArea))
ggplot(pps1, aes(x, y)) +
  geom_tile(aes(fill = pps)) +
  geom_text(aes(label = round(pps, 2), color = pps > 0.8), size = 12 / .pt) +
  scale_fill_distiller(palette = "Green", direction = 1) +
  scale_color_manual(values = c("black", "white")) +
  guides(color = FALSE) +
  labs(
    x = NULL, y = NULL, fill = "Predictive\nPower\nScore", title = "PPS matrix for relation between global forest area\n and air quality ",
    subtitle = "A value represents the predictive power that the\nx variable has on the y variable."
  ) +
  coord_equal() +
  theme(axis.text.x = element_text(angle = 325, hjust = 0, vjust = 0)) +
  theme(plot.subtitle = element_text(size = rel(1))) + 
  theme_minimal()

```
Findings:

Predictive Power Score of 0 shows no relationship between Forest Area and Air Pollution

## Top 10 countries with most air pollution
```{r Air-Pollution-plot, echo=FALSE}
AirPollution %>% 
  drop_na() %>% 
  group_by(Country) %>% 
  summarize(avgAirPollution = mean(AirPollution)) %>% 
  as.data.frame() %>% 
  ungroup() %>% 
  arrange(desc(avgAirPollution)) %>%
  top_n(10) %>% 
  ggplot(aes(x = avgAirPollution, y = reorder(Country, avgAirPollution))) +
  geom_col(fill = "#DE8971", width = 0.5) +
  theme(legend.position = "none") +
  labs(
    x = "Average Air Pollution (Micrograms per cubic metre)",
    y = "Country",
    title = "Top 10 countries with highest air pollution ",
    subtitle = "Time period: 1990 - 2020"
  )+
  scale_x_continuous(labels = scales::comma) +
  theme_minimal()+
  theme(axis.title.x = element_text(color = "Black" ), text = element_text(family="Arial"))
```
Findings:

India has the highest air pollution in the last 30 years 


## Least air pollution

```{r Air-Pollution-plot-least, echo=FALSE}
AirPollution %>% 
  drop_na() %>% 
  group_by(Country) %>% 
  summarize(avgAirPollution = mean(AirPollution)) %>% 
  as.data.frame() %>% 
  ungroup() %>% 
  arrange(desc(avgAirPollution)) %>%
  top_n(-10) %>% 
  ggplot(aes(x = avgAirPollution, y = reorder(Country, -avgAirPollution))) +
  geom_col(fill = "#70AF85", width = 0.6) +
  theme(legend.position = "none") +
  labs(
    x = "Average Air Pollution (Micrograms per cubic metre)",
    y = "Country",
    title = "Top 10 countries with least air pollution",
    subtitle = "Time period: 1990 - 2020"
  )+
  scale_x_continuous(labels = scales::comma) +
  theme_minimal()+
  theme(axis.title.x = element_text(color = "Black" ), text = element_text(family="Arial"))
  

```
Finding:
Nauru has the least air pollution in the last 30 years.


### Air pollution trend in India
```{r India-plot, echo=FALSE}

AirPollution_India <- AirPollution %>% 
  group_by(Year) %>% 
  filter(Country == "India") %>% 
  summarize(AirPollution = mean(AirPollution)) %>% 
  ungroup() 
  


AirPollution_India %>% 
  ggplot(aes(x = Year, y = AirPollution))+
  geom_point(color =  "#79198a", size = 5, alpha = 0.6)+
  geom_line(size = 1.3, alpha = 0.6)+
  labs(title = "Air Pollution in India through decades",
       subtitle = "Time period: 1990-2019",
       x = "Year",
       y = "Average Air Pollution (Micrograms per cubic metre)")+
  theme_fivethirtyeight()+
  theme(axis.title = element_text(),text = element_text(family = "Arial"))+
  theme(plot.subtitle = element_text(size = rel(0.8)))
```
Findings:
* Air Pollution drastically increased after the year 2005.
* It was highest in 2012.
* It decreased in 2005 by ~10 Micrograms per cubic metre.
* Sudden decrease around 2017.
* Increased slightly in 2019 again


### Air pollution trend in Nauru
```{r nauru-plot, echo=FALSE}

AirPollution_Nauru <- AirPollution %>% 
  group_by(Year) %>% 
  filter(Country == "Nauru") %>% 
  summarize(AirPollution = mean(AirPollution)) %>% 
  ungroup() 

AirPollution_Nauru %>% 
  ggplot(aes(x = Year, y = AirPollution))+
  geom_point(color =  "#53ab0f", size = 5, alpha = 0.6)+
  geom_line(size = 1.3, alpha = 0.6)+
  labs(title = "Air Pollution in Nauru through decades",
       subtitle = "Time period: 1990-2019",
       x = "Year",
       y = "Average Air Pollution (Micrograms per cubic metre)")+
  theme_fivethirtyeight()+
  theme(axis.title = element_text(),text = element_text(family = "Arial"))+
  theme(plot.subtitle = element_text(size = rel(0.8)))
```
Findings:
* Air Pollution varies in range of 5 Micrograms per cubic metre and ~7 Micrograms per cubic metre.
* Least in 2014


# Deforestation


```{r echo=FALSE, message=FALSE,warning=FALSE}
intervals <- tibble(read_csv("FRA_2020_data/Intervals_2021_05_05.csv"))

Forest_Area<- tibble(read_csv("FRA_2020_data/fra2020-extentOfForest.csv"))

intervals_1<-intervals %>% mutate(`1d_deforestation`=case_when(year %in% c("1990-2000","2000-2010")~`1d_deforestation`*10,year %in% c("2010-2015","2015-2020")~`1d_deforestation`*5)) %>% mutate(`1d_expansion`=case_when(year %in% c("1990-2000","2000-2010")~`1d_expansion`*10,year %in% c("2010-2015","2015-2020")~`1d_expansion`*5)) %>% mutate(`1d_afforestation`=case_when(year %in% c("1990-2000","2000-2010")~`1d_afforestation`*10,year %in% c("2010-2015","2015-2020")~`1d_afforestation`*5)) %>% mutate(`1e_reforestation`=case_when(year %in% c("1990-2000","2000-2010")~`1e_reforestation`*10,year %in% c("2010-2015","2015-2020")~`1e_reforestation`*5)) %>%mutate(`1d_nat_exp`=case_when(year %in% c("1990-2000","2000-2010")~`1d_nat_exp`*10,year %in% c("2010-2015","2015-2020")~`1d_nat_exp`*5)) 

intervals_2<- intervals_1%>% select(regions,name,`1d_deforestation`,`1d_expansion`,`1d_afforestation`,`1e_reforestation`,`1d_nat_exp`)  %>% group_by(name,regions) %>% summarize(t_deforestation =sum(as.numeric(`1d_deforestation`),na.rm = TRUE),t_expansion=sum(as.numeric(`1d_expansion`),na.rm = TRUE),t_afforestation =sum(as.numeric(`1d_afforestation`),na.rm = TRUE),t_reforestation =sum(as.numeric(`1e_reforestation`),na.rm = TRUE),t_nat_exp =sum(as.numeric(`1d_nat_exp`),na.rm = TRUE))

def_30<-inner_join(intervals_2,Forest_Area,by="name") %>%mutate(t_deforestation=case_when(t_deforestation==0.00  ~ `1990`-`2020`,t_deforestation>0.00 ~ t_deforestation)) %>% mutate(t_deforestation=case_when(t_deforestation<0.00  ~ 0.00,t_deforestation>=0.00 ~ t_deforestation))%>% mutate(year= as.integer((30*`2020`)/t_deforestation))


def_30<-def_30 %>% mutate(percent_change_1=(t_deforestation/`1990`)*100) %>%  mutate(drivers=case_when(percent_change_1<30 ~ "not Drivers",percent_change_1>30  ~"Main Drivers")) %>% mutate(percent_change_1=format(round(percent_change_1,2),nsmall=2))

def_30$name[def_30$name=="Bolivia (Plurinational State of)"]<-"Bolivia"
def_30$name[def_30$name=="Brunei Darussalam"]<-"Brunei"
def_30$name[def_30$name=="Cabo Verde"]<-"Cape Verde"
def_30$name[def_30$name=="Congo"]<-"Democratic Republic of the Congo"
def_30$name[def_30$name=="Côte d'Ivoire"]<-"Ivory Coast"
def_30$name[def_30$name=="French Guyana"]<-"French Guiana"
def_30$name[def_30$name=="Iran (Islamic Republic of)"]<-"Iran"
def_30$name[def_30$name=="Lao People's Democratic Republic"]<-"Laos"
def_30$name[def_30$name=="Micronesia (Federated States of)"]<-"Micronesia"
def_30$name[def_30$name=="Republic of Korea"]<-"South Korea"
def_30$name[def_30$name=="Republic of Moldova"]<-"Moldova"
def_30$name[def_30$name=="Réunion"]<-"Reunion"
def_30$name[def_30$name=="Russian Federation"]<-"Russia"
def_30$name[def_30$name=="Saint Vincent and the Grenadines"]<-"Saint Vincent"
def_30$name[def_30$name=="Syrian Arab Republic"]<-"Syria"
def_30$name[def_30$name=="Trinidad and Tobago"]<-"Trinidad"
def_30$name[def_30$name=="United Kingdom of Great Britain and Northern Ireland"]<-"UK"
def_30$name[def_30$name=="United Republic of Tanzania"]<-"Tanzania"
def_30$name[def_30$name=="United States of America"]<-"USA"
def_30$name[def_30$name=="Venezuela (Bolivarian Republic of)"]<-"Venezuela"
def_30$name[def_30$name=="Viet Nam"]<-"Vietnam"
```
This part deals with the questions related to forest deforestation and environment:

* Deforestation
  + Which countries are the main drivers of deforestation?
  + What are the trends? (by continents)
  + Prediction of how many years it would take until all forests are lost based on the current rate of change.
*Relation to other environmental issues
  + Prediction of how much forest area has to be further increased to tackle the greenhouse gas emissions (what percentage of greenhouse gas decrease will occur if forest area increases).  
  
  
## Drivers of deforstation and forests in the future

Here the visualization of forest is shown country wise by hovering over it.

* Information showed for each country
  + Percentage of forest lost in last three decades 
  + Deforestation is last 30 years
  + Current forest area in (i unit =1000 hac) 
  + Number of years in which complete forest area will be lost depending on the deforestation of specific country in last 3 decades.
  
Countries are being showed in different colors depending on the percentage of of forest lost in last three decades. countries with most percentage of forest lost are the main drivers of deforestation

note: for some countries deforestation data was shown as zero  or not available , for them deforestation was found by finding the difference in forest area between 1990 and 2020
```{r echo=FALSE,  message=FALSE,warning=FALSE}

def_30$code <- countrycode(sourcevar = def_30$name,
                                origin = "country.name",
                                destination = "iso3c")

plot_ly(def_30, type='choropleth', locations=~def_30$code, z=~def_30$percent_change_1, text=~paste(name,paste("Deforestation in last 30 years:",t_deforestation ), paste("current forest area:",`2020` ),paste("Year in which Forest area will be lost:", year) ,sep = "<br />"),colorscale="Rainbow")  %>% colorbar(title = "Percenate of forest lost <br />from deforestation(1 Unit=1000 ha)")%>% layout(
    title = 'Deforestation Analysis in last 3 decades'
  ) 




```


## Deforestation treands by continents 

Below Bargraph plot shows trends in the deforestation over the last three decades over 5 continents 

note : here Americas refer to North and South America. while  oceania refer to Australasia, Melanesia, Micronesia and Polynesia.


```{r echo=FALSE, message=FALSE, warning=FALSE}
world <- map_data("world") %>% group_by(region) %>% filter(row_number()==1)
colnames(world)[5]<-"name"
def_30_world<-inner_join(world,def_30,by="name")
trends<- inner_join(world,intervals_1,by="name") %>% inner_join(Forest_Area,by="name") %>% select(name,year,`1d_deforestation`,`1d_expansion`,`1d_afforestation`,`1e_reforestation`,`1d_nat_exp`)
trends$continent <- countrycode(sourcevar = trends$name,
                            origin = "country.name",
                            destination = "continent")
trends$year[trends$year=="2010-2015"]<-"2010-2020"
trends$year[trends$year=="2015-2020"]<-"2010-2020"

trends_def<-trends %>% group_by(year,continent) %>% summarize(t_deforestation =sum(as.numeric(`1d_deforestation`),na.rm = TRUE),t_expansion=sum(as.numeric(`1d_expansion`),na.rm = TRUE),t_afforestation =sum(as.numeric(`1d_afforestation`),na.rm = TRUE),t_reforestation =sum(as.numeric(`1e_reforestation`),na.rm = TRUE),t_nat_exp =sum(as.numeric(`1d_nat_exp`),na.rm = TRUE)) 

#%>% pivot_longer(cols = contains("t_"),names_to = "continent",values_to = )

plot_ly(trends_def,x=~year,y=~t_deforestation,color = trends_def$continent) %>% layout(
    title = 'Deforestation Trends over last three decades',xaxis = list(title = 'Decades'),yaxis = list(title = 'Total Deforesstation(1 Unit=1000 ha)')
  )


                      

```

## Required forests for Current Co2 emmission.

Below world map plot shows the amount of forest area required to tackle the current Co2 emissions country wise.
As we had only Co2 emission data for every country from 1990-2018 , we have used Arima model time series prediction to predict future Co2 emission.
for this purpose a function was created to predict future Co2 emission for every country.

By taking into consideration, The amount of metric tons Co2 absorbed by forest (that is one acre of new forest can sequester about 2.5 tons of carbon annually).the predicted Co2 value is used to find the amount of additional forest required. 


```{r echo=FALSE, message=FALSE, warning=FALSE}

ghg<- tibble(read_csv("historical_emissions.csv")) 

gh1<-ghg%>% filter(Gas=="CO2" & Country!="World") %>% filter(Sector=="Total including LUCF")
colnames(gh1)[1]<-"name"
gh1$code <- countrycode(sourcevar = gh1$name,
                                origin = "country.name",
                                destination = "iso3c")

#function for time series prediction of the future values co2
predic_2021<-function(country){
x<-gh1 %>% filter(name==country) %>% select(-`Data source`,-Sector,-Gas,-Unit,-code) %>% mutate(`1990`=as.double(`1990`)) %>% pivot_longer(cols = -name,names_to = "year",values_to = "emission") %>% arrange(year)
fit<-arima(ts(x$emission,start = 1990,frequency = 1),order = c(1,2,0))
predict(fit,n.ahead=5)$pred[3]
}

ghg_pre<-gh1 %>% rowwise() %>% mutate(new_area=as.numeric(predic_2021(name))/2.5)




plot_ly(ghg_pre, type='choropleth', locations=ghg_pre$code, z=ghg_pre$new_area, text=ghg_pre$name, colorscale="Green") %>% colorbar(title = "Forest Area <br />Required(1 Unit=1000 ha)") %>% layout(
    title = 'New forest area required <br />to componsate present emission'
  )

```

# Reforestation

```{r load data, include=FALSE}
intervals <- tibble(read_csv("FRA_2020_data/Intervals_2021_05_05.csv"))
fra <- read_csv("FRA_2020_data/FRA_Years_2021_05_05.csv")
```

In this part we want to dig in deeper into the topic of the reforestation by analyzing which countries are the main drivers, whether there is a correlation between reforestation and deforestation and showing the trends over continents.

## Which countries are the main drivers of reforestation?

```{r, include=FALSE}
reforestation <- intervals %>% 
  select(name, year, `1e_reforestation`) %>% 
  mutate(`1e_reforestation` = case_when(
    year == c("1990-2000", "2000-2010") ~ `1e_reforestation` * 10,
    TRUE ~ `1e_reforestation` * 5
    )) %>% 
  group_by(name) %>% 
  summarise(totalref = sum(`1e_reforestation`, na.rm = TRUE)) %>% 
  ungroup()  %>%
  arrange(desc(totalref))

```



```{r, include=FALSE}
refplot <- reforestation %>%
  head(20)
```


```{r, echo=FALSE}
 ggplot(refplot, aes(x = reorder(name, totalref), y = totalref)) +
  geom_col(fill = "Forestgreen") +
  labs(
    y = "Increase between 1990-2020 (1000 ha)",
    x = NULL,
    title = "Top 20 countries of total reforestation between 1990 and 2020"
  ) +
  coord_flip()
```
As these results show mainly countries with a huge surface, we want to put the increase of reforestation from 1990-2020 in relation to the forest area in 1990. 

```{r, include = FALSE}
area <- fra %>%
    group_by(name) %>%
    filter(year == 1990) %>%
    select(name, `1a_forestArea`)
```


```{r, include = FALSE}
increase <- reforestation %>%
  inner_join(area, by = "name") %>%
  mutate(reforestation_increase = (totalref/`1a_forestArea`) * 100) %>%
  arrange(desc(reforestation_increase))
```

```{r, echo=FALSE}
increase %>%
    arrange(desc(reforestation_increase)) %>%
    head(20)%>%
  ggplot(mapping = aes(x = reorder(name, reforestation_increase), y = reforestation_increase)) +
  geom_col(fill = "Forestgreen") +
  labs(
    y = "Increase in %",
    x = NULL,
    title = "Countries and their increase in reforestation from 1990-2020 in relation to their total forest area in 1990"
  ) +
  coord_flip()
```


```{r, include = FALSE, warning = FALSE}
increase$name[increase$name=="Bolivia (Plurinational State of)"]<-"Bolivia"
increase$name[increase$name=="Brunei Darussalam"]<-"Brunei"
increase$name[increase$name=="Cabo Verde"]<-"Cape Verde"
increase$name[increase$name=="Côte d'Ivoire"]<-"Ivory Coast"
increase$name[increase$name=="French Guyana"]<-"French Guiana"
increase$name[increase$name=="Iran (Islamic Republic of)"]<-"Iran"
increase$name[increase$name=="Lao People's Democratic Republic"]<-"Laos"
increase$name[increase$name=="Micronesia (Federated States of)"]<-"Micronesia"
increase$name[increase$name=="Republic of Korea"]<-"South Korea"
increase$name[increase$name=="Republic of Moldova"]<-"Moldova"
increase$name[increase$name=="Réunion"]<-"Reunion"
increase$name[increase$name=="Russian Federation"]<-"Russia"
increase$name[increase$name=="Saint Vincent and the Grenadines"]<-"Saint Vincent"
increase$name[increase$name=="Syrian Arab Republic"]<-"Syria"
increase$name[increase$name=="Trinidad and Tobago"]<-"Trinidad"
increase$name[increase$name=="United Kingdom of Great Britain and Northern Ireland"]<-"UK"
increase$name[increase$name=="United Republic of Tanzania"]<-"Tanzania"
increase$name[increase$name=="United States of America"]<-"USA"
increase$name[increase$name=="Venezuela (Bolivarian Republic of)"]<-"Venezuela"
increase$name[increase$name=="Viet Nam"]<-"Vietnam"
increase$name[increase$name=="Czechia"]<-"Czech Republic"
increase$name[increase$name=="North Macedonia"]<-"Macedonia"
increase$name[increase$name=="Democratic People's Republic of Korea"]<-"North Korea"
increase$name[increase$name=="Congo"]<-"Republic of Congo"
increase$name[increase$name=="Eswatini"]<-"Swaziland"
```


```{r, include = FALSE, warning = FALSE}
world <- map_data("world") %>%
     filter(region != "Antarctica")  


ggplot() +
  geom_map(
    data = world, map = world,
    aes(long, lat, map_id = region)
  ) +
  geom_map(
    data = increase, map = world,
    aes(fill = reforestation_increase, map_id = name)
  ) +
  scale_fill_continuous(
    low="#ffffff", high="#006400", guide="colorbar") +
    scale_y_continuous(breaks=c()) +
    scale_x_continuous(breaks=c()) +
labs(x = NULL, y = NULL, title = "Increase in reforestation between 1990 and 2020 in %", fill = "")
```

```{r, include = FALSE, warning = FALSE}
increase$code <- countrycode(increase$name, origin = "country.name", destination = "iso3c")
  
```

(source of idea https://plotly.com/r/choropleth-maps/#introduction-main-parameters-for-choropleth-outline-maps)
```{r, echo=FALSE, warning = FALSE}

l <- list(color = toRGB("grey"), width = 0.5)

g <- list(
  showframe = FALSE,
  showcoastlines = FALSE
)

increase$reforestation_increase <- round(increase$reforestation_increase)

plot_ly(increase, type='choropleth', locations=increase$code, z=increase$reforestation_increase, text=increase$name, colors = "Greens", marker = list(line = l)) %>% 
colorbar(ticksuffix = '%') %>%
  layout(
    title = 'Increase in reforestation between 1990 and 2020 in %', 
    geo = g
  )
```


## Is there a correlation between reforestation and deforestation?

```{r, include = FALSE}
deforestation <- intervals %>% 
  select(name, year, `1d_deforestation`) %>% 
  mutate(`1d_deforestation` = case_when(
    year == c("1990-2000", "2000-2010") ~ `1d_deforestation` * 10,
    TRUE ~ `1d_deforestation` * 5
    )) %>% 
  group_by(name) %>% 
  summarise(totaldef = sum(`1d_deforestation`, na.rm = TRUE)) %>% 
  ungroup() %>% 
  arrange(desc(totaldef))
```


```{r, include = FALSE}
corref <- reforestation %>%
 inner_join(deforestation, by = "name") %>%
 select(name,totalref, totaldef)
```

First of all we want to show the relation of total reforestation and deforestation in the last 30 years, to get a first impression

```{r, echo=FALSE, warning = FALSE, message = FALSE}
ggplot(data = corref, mapping = aes(x = totalref, y = totaldef)) +
  geom_point() +
  geom_smooth(se = FALSE) +
  ggrepel::geom_text_repel(
    data = filter(corref), 
    aes(label = name), 
    color = "black", size = 7/.pt)+
  labs(x = "total reforestation (1000ha)", y = "total deforestation (1000 ha)")
```

As there are many outliers with either very high deforestation/reforestation figures, we zoom in by changing the scale.

```{r, echo=FALSE, warning = FALSE, message = FALSE}
ggplot(data = corref, mapping = aes(x = totalref, y = totaldef)) +
  geom_point() +
  scale_x_continuous(limits = c(100, 5000)) +
  scale_y_continuous(limits = c(100, 10000)) +
  geom_smooth(se = FALSE) +
  ggrepel::geom_text_repel(
    data = filter(corref), 
    aes(label = name), 
    color = "black", size = 7/.pt)+
  labs(x = "total reforestation (1000ha)", y = "total deforestation (1000 ha)")
```

The figure shows already a high and not linear distrubtion of our data.

```{r, include = FALSE}
corref <- corref %>%
select(totalref, totaldef)
```

With the Shapiro-Wilk test we want to show the normality of our data.

```{r, echo=FALSE}
shapiro.test(corref$totalref)
shapiro.test(corref$totaldef)
```

The values are below 0.05 for both, reforestation and deforestation, the data significantly deviate from a normal distribution. A result which was already highlighted by the graph.

As the data is therefore not linear, we should choose the Spearman method to calculate the correlation.

```{r, echo=FALSE}
corrr::correlate(corref, quiet = TRUE, method = "pearson") 
pear <- cor.test(corref$totalref, corref$totaldef, method = 'pearson')
pear
```

```{r, echo=FALSE, warning = FALSE}
corrr::correlate(corref, quiet = TRUE, method = "spearman") 
Spear <- cor.test(corref$totalref, corref$totaldef, method = 'spearman')
Spear
```

With  a value of 0.451 it shows a moderate correlation, which means, that deforestation has actually an impact on reforestation and a relationship exists. 
 
```{r}
#source code along session 6

pps <- score_df(corref %>% select(totalref, totaldef))

ggplot(pps, aes(x, y)) +
  geom_tile(aes(fill = pps)) +
  geom_text(aes(label = round(pps, 2), color = pps > 0.8), size = 12 / .pt) +
  scale_fill_distiller(palette = "Greens", direction = 1) +
  scale_color_manual(values = c("Green", "white")) +
  guides(color = FALSE) +
  labs(
    x = NULL, y = NULL, fill = "Predictive\nPower\nScore", title = "PPS matrix for relation between deforestation & reforestation",
    subtitle = "A value represents the predictive power that the\nx variable has on the y variable."
  ) +
  coord_equal() +
  theme(axis.text.x = element_text(angle = 325, hjust = 0, vjust = 0)) +
  theme(plot.subtitle = element_text(size = rel(1))) + 
  theme_minimal()
```

## What are the trends by continents?

```{r, include = FALSE}
intervals_1<-intervals %>% 
mutate(`1e_reforestation`=case_when(year %in% c("1990-2000","2000-2010")~`1e_reforestation`*10,year %in% c("2010-2015","2015-2020")~`1e_reforestation`*5))
```


```{r, include = FALSE}
world <- map_data("world") %>% 
  group_by(region) %>% 
  filter(row_number()==1)
colnames(world)[5]<-"name"
  
```

```{r, echo=FALSE, message = FALSE}
trends<- inner_join(world,intervals_1,by="name") %>% 
  select(name,year,`1e_reforestation`)
trends$continent <- countrycode(sourcevar = trends$name,
                            origin = "country.name",
                            destination = "continent")
trends$year[trends$year=="2010-2015"]<-"2010-2020"
trends$year[trends$year=="2015-2020"]<-"2010-2020"

trends_ref<-trends %>% 
  group_by(year,continent) %>% summarize(t_reforestation =sum(as.numeric(`1e_reforestation`),na.rm = TRUE))


plot_ly(trends_ref,x=~year,y=~t_reforestation,color = trends_ref$continent) %>%
  layout(title = 'Reforestation Trends on continents between 1990-2020',
         xaxis = list(title = 'year'),
         yaxis = list(title = 'reforestation (1000 ha)'))
```

# Forest Destruction

```{r loading_data, include=FALSE}
fra_data_tmp <- tibble(read_csv("FRA_2020_data/Annual_2021_05_05.csv"))
temperature_data_tmp <- tibble(read_csv("Environment_Temperature_change_E_All_Data_(Normalized)/Environment_Temperature_change_E_All_Data_(Normalized).csv"))
```

The next part of our project is about forest destruction and tries to answer the following questions:

* What were the main causes of forest destruction?
+ Which countries were affected the most?
+ How much forest was destroyed by each of these causes?
* Is there a correlation between rising temperatures and wildfires?
* Prediction of where and when wildfires are likely to occur.

### Overview and Preprocessing of the available data

##### Our first data set is about forest disturbances (e.g. fire, weather) for the period 2000-2017:  
[FAO. 2020. Global Forest Resources Assessment 2020](https://fra-data.fao.org/WO/fra2020/home/) - data set 2

```{r fra_overview}
glimpse(fra_data_tmp)
```

First we remove everything that we won't need and make column names (of columns that we will later need) more readable: 

* The 'regions' column gets exchanged by a continent column which provides more intuitive information. 
* The 'iso3' column doesn't provide any further information.
* The name and continent column are changed to factor variables.

We also replace missing values with 0, because there is now safe way to impute these values. However this implies that our results for this part of the project are probably an underestimation.

```{r fra_data_processing}
fra_data <- fra_data_tmp %>%
  mutate(continent = countrycode(sourcevar = iso3, origin = "iso3c", destination = "continent"),
         across(everything(), ~ replace_na(.x, 0)),
         name = factor(name),
         continent = factor(continent)) %>% 
  select(-c(iso3, regions)) %>% 
  rename(Insects = `5a_insect`, 
         Diseases = `5a_diseases`, 
         Weather = `5a_weather`, 
         Others = `5a_other`,
         Fire = `5b_fire_forest`) %>% 
  #rename_with(str_to_title) %>% 
  relocate(name, continent, year, Insects, Diseases, Weather, Others, Fire)

fra_data
# Use maybe kable table
# fra_data %>% 
#  kable(caption = "Data on forest desturbances") %>% 
#  scroll_box(width = "100%", height = "200px")
```


##### The second data set we use is about mean surface temperature changes for the period 1961-2020:  
[FAO. 2021. FAOSTAT Temperature Change Dataset](http://www.fao.org/faostat/en/#data/ET) 

```{r temp_overview}
glimpse(temperature_data_tmp %>% select(-Unit)) # Markdown cannot handle the Unit entries.
```

Again we remove everything that we won't need: 

* All 'Code'-columns: Add no information.
* All years that are not in 2000-2017: No forest data for these years.
* The Unit column: it's always °C.
* All missing values (Flags != "Fc") and afterwards the flag column.

```{r temp_data_processing}
temperature_data <- temperature_data_tmp %>% 
  filter(Year %in% 2000:2017,
         Flag == "Fc") %>% 
  select(-c(contains("Code"), Flag, Unit))
# Use maybe kable table
temperature_data
```

After preprocessing we can start answering the questions.  
For the first two questions we decided to look at a global scale and for the country Germany.  
For the third question we decided to look at a global scale and for the continent Europe.

Note: In our interactive shiny website you can pick the country / continent of your interest.

## What were the main causes of forest destruction?

```{r overview}
plot_yearly_forest_destruction_by_region <- function(region = 'Global') {
  fra_data %>% 
    filter(name == region | continent == region | region == 'Global') %>% 
    group_by(year) %>% 
    summarise(Insects = sum(Insects, na.rm = TRUE),
              Diseases = sum(Diseases, na.rm = TRUE),
              Weather = sum(Weather, na.rm = TRUE),
              Others = sum(Others, na.rm = TRUE),
              Fire = sum(Fire, na.rm = TRUE)) %>% 
    pivot_longer(cols = c(Insects, Diseases, Weather, Others, Fire), names_to = "cause", values_to = "area") %>% 
    ggplot(aes(x=year, y=area, fill=reorder(cause,area))) +
    geom_area() +
    scale_x_continuous(breaks = c(2000, 2005, 2010, 2015, 2017)) +
    scale_y_continuous(labels = scales::comma) +
    scale_fill_manual(values = c(Weather = "#2b83ba", Others = "#ffffbf", Fire = "#d7191c",
                                 Diseases = "#fdae61", Insects = "#abdda4")) +
    labs(title = "Forest destruction per year and cause",
         subtitle = glue::glue("Region: {region} - Time period: 2000 - 2017"),
         x = "Year",
         y = "Forest Area [1000 ha]",
         fill = "Cause") +
    theme_minimal()
}

plot_yearly_forest_destruction_by_region()
plot_yearly_forest_destruction_by_region('Germany')
```

#### Findings:

* On a global scale wildfires are clearly the dominant cause of forest destruction over the years.
* However, this does not apply for every individual country:
  + Germany's main cause for forest destruction are insects.
  + Note: the peak in this plot was caused by the heat wave in 2003.
* There is no obvious trend to find over this small time scale.

## How much forest was destroyed by each of these causes?

```{r area_by_cause, echo=FALSE}

plot_total_forest_destruction_by_region <- function(region = 'Global') {
  disturbance_data <- fra_data %>% 
    filter(name == region | region == 'Global') %>% 
    select(-`5b_fire_land`) %>% 
    mutate(Insects = sum(Insects, na.rm = TRUE)) %>% 
    mutate(Diseases = sum(Diseases, na.rm = TRUE)) %>% 
    mutate(Weather = sum(Weather, na.rm = TRUE)) %>% 
    mutate(Others = sum(Others, na.rm = TRUE)) %>% 
    mutate(Fire = sum(Fire, na.rm = TRUE)) %>% 
    pivot_longer(cols = c(Insects, Diseases, Weather, Others, Fire), names_to = "cause", values_to = "area") %>% 
    slice(1:5) %>% 
    select(cause, area)
  
  bar_plot <- ggplot(disturbance_data, aes(x = reorder(cause,desc(area)), y = area, fill = cause)) + 
    geom_col() +
    labs(title = "Total forest destruction by cause",
         subtitle = glue::glue("Region: {region} - Time period: 2000 - 2017"),
         x = "",
         y = "Forest Area [1000 ha]") +
    scale_y_continuous(labels = scales::comma) +
    scale_fill_manual(values = c(Weather = "#2b83ba", Others = "#ffffbf", Fire = "#d7191c",
                                 Diseases = "#fdae61", Insects = "#abdda4")) +
    theme_minimal() +
    guides(fill = FALSE)
  
  pie_plot <- ggplot(disturbance_data, aes(x="", y = area, fill = reorder(cause, desc(area)))) + 
    geom_bar(stat="identity", width=1) +
    coord_polar("y") +
    scale_fill_manual(values = c(Weather = "#2b83ba", Others = "#ffffbf", Fire = "#d7191c",
                                 Diseases = "#fdae61", Insects = "#abdda4")) +  
    labs(x = "",
         y = "Forest Area [1000 ha]",
         fill = "Cause") +
    theme_void()
  
  bar_plot + pie_plot
}

```

```{r}
plot_total_forest_destruction_by_region()
```

```{r}
plot_total_forest_destruction_by_region('Germany')
```

#### Findings:

* On a global scale wildfires make up more than 50% of forest destruction, destroying more than 1 Billion ha of forest.
* Insects make up almost 25% of forest destruction, destroying roughly 500 Million ha of forest.
* These two are clearly the main drivers of global forest destruction.
* Germany:
  + Insects and diseases are the main drivers of German forest destruction, destroying approximately 2.5 Million ha of forest over this 18 years time period.
  + Wildfires are no significant problem in Germany. 

## Which countries were affected the most?

```{r most_affected}
plot_highest_forest_destruction <- function(cont = 'Global', number = 15, cs = 'All') {
  
  fra_data %>% 
    filter(continent == cont | cont == 'Global') %>% 
    select(name, c(Insects, Diseases, Weather, Others, Fire)) %>% 
    group_by(name) %>% 
    summarise(Insects = sum(Insects, na.rm = TRUE),
              Diseases = sum(Diseases, na.rm = TRUE),
              Weather = sum(Weather, na.rm = TRUE),
              Others = sum(Others, na.rm = TRUE),
              Fire = sum(Fire, na.rm = TRUE)) %>% 
    ungroup() %>% 
    pivot_longer(cols = c(Insects, Diseases, Weather, Others, Fire), names_to = "cause", values_to = "area") %>% 
    filter(cause == cs | cs == 'All') %>% 
    group_by(name) %>% 
    mutate(total = sum(area, na.rm = TRUE)) %>% 
    ungroup() %>% 
    arrange(desc(total)) %>% 
    slice(1:(5*number)) %>% 
    ggplot(aes(x=area, y=reorder(name, area), fill=reorder(cause, desc(area)))) +
    geom_col() +
    scale_x_continuous(labels = scales::comma) +
    scale_fill_manual(values = c(Weather = "#2b83ba", Others = "#ffffbf", Fire = "#d7191c",
                                 Diseases = "#fdae61", Insects = "#abdda4")) + 
    labs(title = glue::glue("The {number} Countries with the highest forest destruction"),
         subtitle = glue::glue("Region: {cont} - Time period: 2000 - 2017"),
         x = "Forest Area [1000 ha]",
         y = "Country",
         fill = "Cause") +
    theme_minimal()
  
}

plot_highest_forest_destruction()
# ggplotly(plot_highest_forest_destruction())
plot_highest_forest_destruction("Europe", 5, "All")
```

#### Findings:

* As one would expect from our previous findings, the most affected countries mostly struggle with wildfires.
* The only exceptions to this are: USA, Canada, China, Sudan and Mexico.
* Brazil is most affected country and has a huge wildfire problem.
  + Assumption: since Brazil is a tropical region and therefore very humid these wildfires are probably caused by humans.
* Europe:
  + Except for Russia, Europe's most affected countries have no problem with wildfires. 

## Is there a correlation between rising temperatures and wildfires?

#### Overview:

```{r fire_temp_corr_preprocessing, include=FALSE}
global_yearly_tc <- temperature_data %>% 
  filter(Area == 'World', 
         Element == 'Temperature change', 
         Months == 'Meteorological year'
  ) %>% 
  select(Year, Value) %>% 
  rename(year = Year, temp_increase = Value)

global_yearly_tc

# Preprocessing of FRA data missing
fra_tc_global <- inner_join(fra_data, global_yearly_tc, by=c("year"))

fra_tc_global
```

```{r todo, include=FALSE}
local_yearly_tc <- temperature_data %>% 
  filter(Element == 'Temperature change', 
         Months == 'Meteorological year') %>% 
  select(Area, Year, Value) %>% 
  rename(name = Area, year = Year, temp_increase = Value)

fra_tc_local <- inner_join(fra_data, local_yearly_tc, by=c("name", "year"))

fra_tc_local
```

```{r fire_temp_corr_plot3}
fra_tc_global %>% 
  group_by(year) %>% 
  summarise(fire = sum(Fire, na.rm = TRUE), 
            temp = mean(temp_increase)) %>% 
  ggplot(aes(x=year, y=fire, fill = temp)) +
  geom_col() + 
  scale_y_continuous(labels = scales::comma) +
  scale_fill_viridis_c(option = "inferno") +
  labs(title = "Global area of wildfires per year",
       subtitle = "Time period: 2000 - 2017",
       x = "Year",
       y = "Wildfire Area [1000 ha]",
       fill = "Temperature increase in C°") +
  theme_minimal()
```

Our first visualization doesn't suggest any linear correlation, but it can be improved to make the interpretation clearer.

Next we compare global yearly temperature changes to global forest area destructed by wildfires.

```{r fire_temp_corr_plot}
# Forest
fra_tc_global %>% 
  group_by(year) %>% 
  summarise(fire = sum(Fire, na.rm = TRUE), 
            temp = temp_increase) %>% 
  ggplot(aes(x=temp, y=fire)) +
  geom_line() + 
  geom_point() +
  labs(
    title = "Relationship between global temperature increase and wildfire area",
    subtitle = "Time period: 2000 - 2017",
    x = "Temperature Increase [C°]",
    y = "Wildfire Area [1000 ha]" 
  ) +
  theme_minimal()

# Land
# fra_tc_global %>% 
#   group_by(year) %>% 
#   summarise(fire = sum(`5b_fire_land`, na.rm = TRUE), 
#             temp = temp_increase) %>% 
#   ggplot(aes(x=temp, y=fire)) +
#   geom_line() + 
#   geom_point() +
#   labs(
#     title = "Relationship between global temperature increase and gloabl fire area",
#     subtitle = "Time period: 2000 - 2017",
#     x = "Temperature Increase [C°]",
#     y = "Fire Area [1000 ha]" 
#   ) +
#   theme_minimal()

# TODO: Change argumentation chain 
# Keep in mind that land includes forest!!!
```

There is no linear correlation visible for both land and forest fires and rising temperatures.

Now we compare global yearly temperature changes to the global count of wildfires.

```{r fire_temp_corr_plot2}
# TODO: Summarize / Ungroup refactoring?
# Forest
fra_tc_global %>% 
  mutate(Fire = case_when(
    is.na(Fire) | Fire == 0 ~ FALSE,
    TRUE ~ TRUE
  )) %>% 
  group_by(year) %>% 
  summarise(fire = sum(Fire, rm.na = TRUE), temp = mean(temp_increase)) %>% 
  ungroup() %>% 
  ggplot(aes(x=temp, y=fire)) +
  geom_line() + 
  geom_point() +
  labs(
    title = "Relationship between global temperature increase and the amount of wildfires",
    subtitle = "Time period: 2000 - 2017",
    x = "Temperature Increase [C°]",
    y = "Wildfire Area [1000 ha]" 
  ) +
  theme_minimal()

# # Land
# fra_tc_global %>% 
#   mutate(`5b_fire_land` = case_when(
#     is.na(`5b_fire_land`) | Fire == 0 ~ FALSE,
#     TRUE ~ TRUE
#   )) %>% 
#   group_by(year) %>% 
#   summarise(fire = sum(`5b_fire_land`, rm.na = TRUE), 
#             temp = temp_increase) %>% 
#   ggplot(aes(x=temp, y=fire)) +
#   geom_line() + 
#   geom_point() +
#   labs(
#     title = "Relationship between global temperature increase and the global amount of fires",
#     subtitle = "Time period: 2000 - 2017",
#     x = "Temperature Increase [C°]",
#     y = "Wildfire Area [1000 ha]" 
#   ) +
#   theme_minimal()
```

Again there is no linear correlation visible for both land and forest fires and rising temperatures.
Maybe we can find a correlation if go more into detail and show not only global values but values for each country and each year:

```{r}
fra_tc_local %>% 
  filter(!is.na(Fire)) %>% 
  ggplot(aes(y=Fire, x=temp_increase, color = continent)) +
  geom_point(alpha = 0.5) +
  # geom_smooth(se = FALSE) +
  scale_y_continuous(labels = scales::comma) +
  labs(title = "Area of wildfires per year and country",
       subtitle = "Time period: 2000 - 2017",
       x = "Temperature increase in C°",
       y = "Wildfire Area [1000 ha]",
       color = "Continent") +
  theme_minimal()
```

```{r animated_plot}

p <- fra_tc_local %>% 
  filter(!is.na(Fire)) %>% 
  mutate(year = as.integer(year)) %>% 
  ggplot(aes(y=Fire, x=temp_increase, color = continent)) +
  geom_point(alpha = 0.5, show.legend = FALSE) +
  # geom_smooth(se = FALSE) +
  facet_wrap(~continent) +
  scale_y_continuous(labels = scales::comma) +
  theme_minimal() +
  labs(title = "Area of wildfires per year and country",
       subtitle = "Year: {frame_time}",
       x = "Temperature increase in C°",
       y = "Wildfire Area [1000 ha]",
       color = "Continent") +
  transition_time(year) +
  ease_aes('linear')


animate(p, renderer = gifski_renderer())
```

We need a way to quantify these results. Since the data is clearly not linear we use the Predicitive Power Score [..] as a measure for correlation.

```{r}
# Code from ex-6-codealong.Rmd
# TODO: Change design of plots
# subtitle = "A value represents the predictive power that the\nx variable has on the y variable."


plot_pps <- function(pps, title) {
  ggplot(pps, aes(x, y)) +
    geom_tile(aes(fill = pps)) +
    geom_text(aes(label = round(pps, 2), color = pps > 0.8), size = 12 / .pt) +
    scale_fill_distiller(palette = "Greys", direction = 1) +
    scale_color_manual(values = c("black", "white")) +
    guides(color = FALSE) +
    labs(
      x = NULL, y = NULL, fill = "Predictive\nPower\nScore", title = title
    ) +
    coord_equal() +
    theme_minimal()# +
    #theme(axis.text.x = element_text(angle = 325, hjust = 0, vjust = 0)) +
    #theme(plot.subtitle = element_text(size = rel(1))) 
}

pps1 <- score_df(fra_tc_global %>% 
                   group_by(year) %>% 
                   summarise(Wildfires = sum(Fire, na.rm = TRUE), 
                             Temperature = mean(temp_increase)) %>% ungroup() %>% 
                   select(Temperature, Wildfires))

p1 <- plot_pps(pps1, "PPS matrix for\nglobal wildfire area")

pps2 <- score_df(fra_tc_global %>% 
                   mutate(Fire = case_when(
                     is.na(Fire) | Fire == 0 ~ FALSE,
                     TRUE ~ TRUE
                   )) %>% 
                   group_by(year) %>% 
                   summarise(Wildfires = sum(Fire, na.rm = TRUE), 
                             Temperature = mean(temp_increase)) %>% 
                   ungroup() %>% 
                   select(Temperature, Wildfires))

p2 <- plot_pps(pps2, "PPS matrix for\nglobal wildfire count")

#pps3 <- score_df(fra_tc_local %>% select(name, temp_increase, Fire))

#p3 <- plot_pps(pps3, "PPS matrix for\ncountry wildfire area")

p1 + p2 + plot_layout(guides = 'collect')
```

#### Findings:

* There is clearly no correlation recognizable in our data between temperature increase and wildfires.

## Prediction of where and when wildfires are likely to occur.

First we look at the available data and see which columns might help us to make a prediction.

```{r wildfire_prediction}
temperature_data
fra_data

temp <- temperature_data %>% 
  filter(Element == 'Temperature change', 
         Months == 'Meteorological year') %>% 
  select(Area, Year, Value) %>% 
  rename(name = Area, year = Year, temp_increase = Value)

# Interpretation of NA's as No Wild Fire, because of the structur of the entries for this column
fra <- fra_data %>% 
  mutate(Fire = case_when(
    Fire == 0 ~ "No",
    TRUE ~ "Yes"
  )) %>% 
  mutate(Fire = factor(Fire)) %>% 
  rename(wildfire = Fire)

fra_tc_data <- inner_join(fra, temp, by=c("name", "year"))

fra_tc_data[is.na(fra_tc_data)] <- 0
fra_tc_data
```

We got roughly 3800 samples for the prediction

```{r prepare_data}
set.seed(123)

# Specify data splits 
init_split <- initial_split(fra_tc_data, strata = wildfire)
wf_training <- training(init_split)
wf_testing <- testing(init_split)

# 5-fold cross validation
wf_cv <- vfold_cv(wf_training, v = 5)
```

```{r model_specs}
# Logistic regression
lr_model_spec <- logistic_reg() %>%
  set_engine("glm") %>%
  set_mode("classification")

# Decision Tree
dt_model_spec <- decision_tree() %>% 
  set_engine("rpart") %>% 
  set_mode("classification")
```

```{r model_validation}
# Fit models on cv training data
wf <- workflow() %>%
  add_formula(wildfire ~ temp_increase) %>% 
  add_model(lr_model_spec)

lr_results_1 <- wf %>% 
  fit_resamples(wf_cv) %>% 
  collect_metrics()

wf <- wf %>% update_model(dt_model_spec)

dt_results_1 <- wf %>% 
  fit_resamples(wf_cv) %>% 
  collect_metrics()

lr_results_1
dt_results_1

# Decision Tree has a better performance
```

```{r model_validation_2}
# Next step: find optimal formula

wf <- wf %>% update_formula(wildfire ~ name + continent + temp_increase + boreal + temperate+ tropical+ subtropical + Insects + Diseases + Weather + Others
)

dt_results_2 <- wf %>% 
  fit_resamples(wf_cv) %>% 
  collect_metrics()

dt_results_2
```

```{r model_evaluation}
dt_fit <- fit(dt_model_spec, wildfire ~ name + continent + temp_increase + boreal + temperate+ tropical+ subtropical + Insects + Diseases + Weather + Others, wf_training)
rpart.plot::rpart.plot(dt_fit$fit)

predict(dt_fit, new_data = wf_testing) %>%
  mutate(truth = wf_testing$wildfire) %>%
  accuracy(estimate = .pred_class, truth = truth)

# prediction of when a wildfire occurs sees to be impractical because the most / only important factor is the country
# remove year - doesn't make any sence to use it predict upcoming wildfires

#predict(fit, new_data = wf_testing) %>%
# mutate(truth = wf_testing$wildfire) %>%
#accuracy(estimate = .pred_class, truth = truth)

#predict(fit2, new_data = wf_testing) %>%
# mutate(truth = wf_testing$wildfire) %>%
#accuracy(estimate = .pred_class, truth = truth)
#rpart.plot::rpart.plot(results4$)
```

```{r}
dt_fit <- fit(dt_model_spec, wildfire ~ temp_increase + boreal + temperate + tropical+ subtropical + Insects + Diseases + Weather + Others, wf_training)
rpart.plot::rpart.plot(dt_fit$fit)

predict(dt_fit, new_data = wf_testing) %>%
  mutate(truth = wf_testing$wildfire) %>%
  accuracy(estimate = .pred_class, truth = truth)
```

#### Findings:

* Our most accurate prediction depends only on the given country and is therefore not very useful in finding the underlying source of wildfires.
* If we remove the country as a predictor, the main factor of deciding whether a wildfire occurs our not is the temperature, which is kind of a contradiction to our previous question.

# Further questions

## Correlation between greenhouse gas emissions and total carbon stored in forests

1. [Emission Dataset](https://www.climatewatchdata.org/data-explorer/historical-emissions?historical-emissions-data-sources=cait&historical-emissions-gases=all-ghg&historical-emissions-regions=All%20Selected&historical-emissions-sectors=total-including-lucf&page=1)
2. [Carbon Stock Dataset](https://fra-data.fao.org/WO/fra2020/home/)
3. [Forest Area Dataset](http://www.fao.org/faostat/en/#data/GF)

#### Preprocessing 
The first dataset containing data about the volume of carbon emitted per country per year (1990-2020) is processed here;\

1. Some columns were processed to make them consistent with others and for easy identification\
2. Missing values and and irrelevant columns were dropped \
3. The year column was made longer (pivot_longer).


```{r emissiondataSet, results='hide'}
emissionData <- read_csv("historical_emissions.csv")
colnames(emissionData)[colnames(emissionData) == "Country"] <- "country" 
colnames(emissionData)[colnames(emissionData) == "Data source"] <- "DataSource" 
emissionData$`1990` <- as.numeric(emissionData$`1990`)

emissionData <- emissionData %>%
 drop_na()%>%
 select(-DataSource, -Sector, -Unit)%>%
 pivot_longer(!c(country,Gas), names_to = "year", values_to = "emissionValue")%>%
 filter(country!='World' & country != "European Union (27)")

```

#### Analysis and Visualizations of GHG Emissions

* Here we visualized the top 20 emitters of carbon globally, within defined period. The result is below.


```{r top-countries-in-ghg-emissions, results = 'hide'}
emissionData%>%
  group_by(country)%>%
  summarise(avgEmission = mean(emissionValue))%>%
  arrange(desc(avgEmission))%>%
  top_n(20)%>%
  ggplot(aes(x=avgEmission, y=reorder(country, avgEmission))) + 
  geom_col(fill="red") + 
  labs(title='Top 20 emitters of GreenHouse gases (1990 - 2018)',
                                 x = 'Average Emissions [1000 tonnes]', y = 'Country')+
  theme(legend.position = "none")+
  scale_x_continuous(labels = scales::comma)
   
```

* As seen below, we sought to know the proportionate constituents of the green house gases; hence the plot below; \

```{r piecharts-for-proportion-of-GHG-gases, results = 'hide'}
library(IRdisplay)
mycols <- c("##009999", "#EFC000FF", "#868686FF", "#CD534CFF")
pieData <- emissionData%>%
  group_by(Gas)%>%
  summarise(Value = sum(emissionValue))%>%
  filter(Gas !="All GHG")%>%
  mutate(percentvalue = round(Value / sum(Value)*100), digits=0)%>%
  arrange(percentvalue)

pie <- ggplot(data = pieData, aes(x = "", y = percentvalue, fill = Gas)) +
  geom_col(color='black') +
  coord_polar("y", start = 0) +
  geom_text(aes(label = paste0(percentvalue, "%")), position = position_stack(vjust = 0.5))+
  theme(panel.background = element_blank(),
                    axis.line = element_blank(),
                    axis.text = element_blank(),
                    axis.ticks = element_blank(),
                    axis.title = element_blank(),
                    plot.title = element_text(hjust = 0.5, size = 18))+
  ggtitle("Proportion of GHG gases") 
pie 
```

* The average emission per country from 1990 - 2020 was also visualized below 
```{r worldmap, results = 'hide'}
library(rworldmap)
dataAggregate <- aggregate(emissionValue ~ country, emissionData, mean)
colnames(dataAggregate)[colnames(dataAggregate) == "emissionValue"] <- "Average Emission Value [MtCO₂e] per Country from 1990 to 2020"
worldmaps <- joinCountryData2Map(dataAggregate, nameJoinColumn = "country", joinCode = "NAME")
colourPalette <- RColorBrewer::brewer.pal(10, 'Reds')
mapCountryData(worldmaps, 
               nameColumnToPlot = "Average Emission Value [MtCO₂e] per Country from 1990 to 2020",
               catMethod = 'fixedWidth', 
               colourPalette = 'diverging', 
               numCats = 50)
```


#### Carbon stock

This dataset captures the carbon stock per country for selected 9 years (1990,2000,2010,2015,2016,2017,2018,2019,2020)

#### Preprocessing

1. Some columns were converted to a consistent data type\
2. Missing values were handled with the mice library\
3. Years not captured in the dataset were replaced with the mean carbon stock per country\
4. The unit of the carbon stock was tonnes/ha, where ha is the forest size in hectres\
5. Hence carbon stock was multiplied with forest area.
6. Finally, the emission dataset was merged with the carbon stock to perform correlation.

```{r carbon-stock-dataset, results='hide'}
library(mice)
library(data.table)
data <- read.csv("fra2020-carbonStock.csv")
data$X1990 <- as.numeric(data$X1990)
data <- data[which(rowMeans(is.na(data))<0.5), ]
impute_data <- mice(data, m=5, maxit = 5, seed = 100)
clean_data <- complete(impute_data, 2)
clean_data <- group_by(clean_data, country)
clean_data <- mutate(clean_data, dataMean = mean(c(X1990,X2000,X2010,X2015,X2016,X2017,X2018,X2019,X2020)))

clean_data <- cbind(clean_data, replicate (22, clean_data$dataMean),simplify = FALSE)
clean_data <- setnames(clean_data, old = c("...12","...13","...14","...15","...16","...17","...18","...19","...20",
                                           "...21","...22","...23","...24","...25","...26","...27","...28","...29",
                                           "...30","...31","...32","...33"),
                       new = c("X1991","X1992","X1993","X1994","X1995","X1996","X1997","X1998","X1999","X2001","X2002",
                               "X2003","X2004","X2005",
                               "X2006","X2007","X2008","X2009","X2011","X2012","X2013","X2014"), skip_absent = TRUE)
clean_data <- select(clean_data,'country',c("X1990","X1991","X1992","X1993","X1994","X1995","X1996","X1997",
                                            "X1998","X1999","X2001","X2002","X2003","X2004","X2005","X2006",
                                            "X2007","X2008","X2009","X2011","X2012","X2013","X2014","X2015","X2016",
                                            "X2017","X2018","X2019","X2020"))
carbonStockData <- pivot_longer(clean_data, X1990:X2020, names_to = 'year', values_to = 'carbonStockValue')
carbonStockData <-separate(carbonStockData, col=year, into = c("y","year"), sep="X")
carbonStockData$y <- NULL


forestArea <- read_csv("FAOSTAT_data_6-9-2021.csv")
colnames(forestArea)[colnames(forestArea) == "Area"] <- "country"
colnames(forestArea)[colnames(forestArea) == "Value"] <- "Area"
colnames(forestArea)[colnames(forestArea) == "Year"] <- "year"
forestArea <- select(forestArea, c('country', 'year','Area'))

#merging carbonstock dataset with Forest Area dataset
carbonStockData <- merge(carbonStockData, forestArea, by=c("country","year"))
carbonStockData <- mutate(carbonStockData, carbonInTonnes = (carbonStockValue * Area))
```

#### Analysis and Visualization  of carbon stock 

* The trend of carbon stock globally from 1990 to 2018 was shown below\

```{r merged-data-for-correlation, results = 'hide'}
mergedData <- merge(carbonStockData, emissionData, by=c("country","year"))%>%
  select(c('year', 'country','carbonInTonnes','emissionValue'))%>%
  drop_na()%>%
  group_by(year)%>%
  summarize(carbonStockSum = mean(carbonInTonnes), emissionSum = mean(emissionValue))%>%
  unique()

```

* Comparatively, the trend of the emitted GHG from 1990 to 2018 was also shown \
```{r trend-of-carbon-stock, echo=FALSE, results = 'hide'}
mergedData%>%
  ggplot(aes(year, carbonStockSum, group=1)) + geom_line() + 
  geom_point(aes(colour = "red")) + 
  scale_x_discrete(guide = guide_axis(check.overlap = TRUE))+
  scale_y_continuous(labels = scales::comma) + 
  labs(title="Carbon Stock trend from 1990 to 2018", x = "Year", y = "Carbon Stock [1000 tonnes]") +
  theme(legend.position = "none")
```
* Comparatively, the trend of the emitted GHG from 1990 to 2018 was also shown \
```{r trend-of-carbon-emitted, echo=FALSE, results = 'hide'}
mergedData%>%
  ggplot(aes(year, emissionSum, group=1)) + geom_line() + 
  geom_point(aes(colour = "red")) + 
  scale_x_discrete(guide = guide_axis(check.overlap = TRUE))+
  scale_y_continuous(labels = scales::comma) + 
  labs(title="Trend of emitted GHG from 1990 to 2018", x = "Year", y = "GHG emitted [1000 tonnes]") +
  theme(legend.position = "none")
  #theme_bw()
```

* Here we visualized the countries with the largest carbon stock
```{r countries-with the-highest-carbon-stock-in-forests, echo=FALSE, results = 'hide'}
carbonStockData %>%
  drop_na()%>%
  group_by(country)%>%
  summarise(avgCarbon = mean(carbonInTonnes))%>%
  arrange(desc(avgCarbon))%>%
  top_n(20)%>%
  ggplot(aes(x=avgCarbon, y=reorder(country, avgCarbon))) + geom_col(fill='limegreen') + labs(title='Largest carbon stock in forests (1990 - 2020)', x = 'Average Carbon Stock [1000 tonnes]', y = 'Country') + scale_color_viridis_c(option = "inferno") + theme(legend.position = "none")+scale_x_continuous(labels = scales::comma)
  
```


#### Correlation proper
We seek to answer the correlation question here, we start by comparing both variables per year.

* Correlation plot
```{r correlation-plots2, echo=FALSE, results = 'hide'}
mergedData%>%
  ggplot(aes(x=emissionSum, y=carbonStockSum)) + geom_point(color="red") +
  labs(x="GHG emissions [1000 tonnes]", y = "Sum of carbon stock in forests [1000 tonnes]", title="GHG emissions against carbon stock in forests, per year") +
  geom_smooth(method = 'lm', fill="darkolivegreen2") +
  scale_y_continuous(labels = scales::comma)
  
```

#### Correlation result

```{r correlation, echo=FALSE}
x <- cor(x=mergedData$emissionSum, y=mergedData$carbonStockSum, use = "everything", method = "kendall")
paste("Kendall = ", x)

y <- cor(x=mergedData$emissionSum, y=mergedData$carbonStockSum, use = "everything", method = "spearman")
paste("Spearman = ", y)

z <- cor(x=mergedData$emissionSum, y=mergedData$carbonStockSum, use = "everything", method = "pearson")
paste("Pearson = ", z)
```
**Interpretation of the correlation coefficient;** both variables are negatively correlated using all correlation methods. Most likely, if the emission increases, the carbon stock decreases. However, this relationship can not be ascertained using correlation because correlation does not necessarily imply causation.

Also, the absolute value of approximately 1.0 depicts perfectly linear correlation between both variables.

## How much gas will be absorbed if forest area increases

#### Introduction\
Here, the objective of our analysis is to investigate how much GHG will be absorbed if forest area is increased. To do this, we use the carbon stock and forest area datasets already loaded.


#### Analysis and Visualization

* Comparison between absorbed carbon and forest area
```{r forest-area-against-absorbed-carbon, echo=FALSE, results='hide'}
library(mice)
data <- read_csv("fra2020-carbonStock.csv")
forestArea <- read_csv("FAOSTAT_data_6-9-2021.csv")
colnames(forestArea)[colnames(forestArea) == "Area"] <- "country"
colnames(forestArea)[colnames(forestArea) == "Value"] <- "Area"

data <- data%>%
 pivot_longer(c("1990","2000","2010","2015","2016","2017","2018","2019","2020"), names_to = 'Year', values_to = 'carbonStock')%>%
 merge(forestArea, by=c("country","Year"))%>%
 select(c("country","Year","Area","carbonStock"))%>%
 mice(m=5, maxit = 5, seed = 100)%>%
 complete(2)%>%
 group_by(Year)%>%summarise(totalArea = sum(Area), totalCarbonAbsorbed = sum(carbonStock))
data
```

```{r regression-plots, echo=FALSE}
df_reg_lines <- expand_grid(intercept = 82:88, slope = seq(0.4, 0.6, 0.1))
data %>%
  ggplot(aes(y = totalArea, x = totalCarbonAbsorbed)) + geom_point(color="red1") + geom_smooth(method = "lm", size = 1, fill="deepskyblue2") + 
 labs(y = "Forest Area [1000ha]", x = "Carbon Absorbed [MtCO2]", title = "Comparison between absorbed carbon and forest area")
```
The result below was gotten after using linear regression \

#### Result
```{r linear-regression, echo=FALSE}
library(tidymodels)
linear_reg() %>%
 set_engine("lm") %>%
 fit(formula = totalCarbonAbsorbed ~ totalArea, data = data) %>%
 tidy()
```

* Carbon_absorbed = 392	+ 0.00243 * totalArea \

* For a unit increase in total forest area, the volume of carbon absorbed should increase by 0.00243 \

* If there are no forests ie totalArea = 0, the volume of carbon absorbed will be 392.\

* Therefore, a unit increase in forest area, results in a decrease in the quantity of emitted CO2 by 0.00243

# Summary

# Ressources

PPS Score code from ex_6_codealong session 
