---
title: "DataSci With R"
#author: "me"
#date: "06/16/2021"
output: html_document
---

### Question: Correlation between greenhouse gas emissions and total carbon stored in forests

```{r setup, include=FALSE}
chooseCRANmirror(graphics=FALSE, ind=1)
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(message = FALSE)
knitr::opts_chunk$set(warning = FALSE)
#knitr::opts_chunk$set(results = 'hide')
knitr::opts_chunk$set(fig.width = 8)
install.packages("stringr")
install.packages("rworldmap")
install.packages('plyr', repos = "http://cran.us.r-project.org")
install.packages("plotly")
install.packages("IRdisplay")
library(RColorBrewer)
library(tidyverse)
library(mice)
library(stringr)
library(rworldmap)
library(data.table)
library(tidymodels)
library(plotly)

#emissionData <- read.csv("FAOSTAT_emission.csv")
#forestArea <- read_csv("FAOSTAT_data_6-9-2021.csv")
#data <- read.csv("fra2020-carbonStock.csv")
#data3 <- read_csv("Newhistorical_emissions.csv")
```

#### Introduction\
This project question seeks to discover if there is an existing correlation between greenhouse gas (carbon) emissions and the total carbon stored in forests. To answer this, we considered three datasets each of which has relevant attributes that enabled us carryout our analysis.

The links to the datasets are below;

1. [Emission Dataset](https://www.climatewatchdata.org/data-explorer/historical-emissions?historical-emissions-data-sources=cait&historical-emissions-gases=all-ghg&historical-emissions-regions=All%20Selected&historical-emissions-sectors=total-including-lucf&page=1)
2. [Carbon Stock Dataset](https://fra-data.fao.org/WO/fra2020/home/)
3. [Forest Area Dataset](http://www.fao.org/faostat/en/#data/GF)

#### Preprocessing 
The first dataset containing data about the volume of carbon emitted per country per year (1990-2020) is processed here;\

1. Some columns were processed to make them consistent with others and for easy identification\
2. Missing values and and irrelevant columns were dropped \
3. The year column was made longer (pivot_longer).


```{r emissiondataSet, results='hide'}
emissionData <- read_csv("historical_emissions.csv")
colnames(emissionData)[colnames(emissionData) == "Country"] <- "country" 
colnames(emissionData)[colnames(emissionData) == "Data source"] <- "DataSource" 
emissionData$`1990` <- as.numeric(emissionData$`1990`)

emissionData <- emissionData %>%
 drop_na()%>%
 select(-DataSource, -Sector, -Unit)%>%
 pivot_longer(!c(country,Gas), names_to = "year", values_to = "emissionValue")%>%
 filter(country!='World' & country != "European Union (27)")

```

#### Analysis and Visualizations of GHG Emissions

* Here we visualized the top 20 emitters of carbon globally, within defined period. The result is below.


```{r top-countries-in-ghg-emissions, results = 'hide'}
emissionData%>%
  group_by(country)%>%
  summarise(avgEmission = mean(emissionValue))%>%
  arrange(desc(avgEmission))%>%
  top_n(20)%>%
  ggplot(aes(x=avgEmission, y=reorder(country, avgEmission))) + 
  geom_col(fill="red") + 
  labs(title='Top 20 emitters of GreenHouse gases (1990 - 2018)',
                                 x = 'Average Emissions [1000 tonnes]', y = 'Country')+
  theme(legend.position = "none")+
  scale_x_continuous(labels = scales::comma)
   
```

* As seen below, we sought to know the proportionate constituents of the green house gases; hence the plot below; \

```{r piecharts-for-proportion-of-GHG-gases, results = 'hide'}
library(IRdisplay)
mycols <- c("##009999", "#EFC000FF", "#868686FF", "#CD534CFF")
pieData <- emissionData%>%
  group_by(Gas)%>%
  summarise(Value = sum(emissionValue))%>%
  filter(Gas !="All GHG")%>%
  mutate(percentvalue = round(Value / sum(Value)*100), digits=0)%>%
  arrange(percentvalue)

pie <- ggplot(data = pieData, aes(x = "", y = percentvalue, fill = Gas)) +
  geom_col(color='black') +
  coord_polar("y", start = 0) +
  geom_text(aes(label = paste0(percentvalue, "%")), position = position_stack(vjust = 0.5))+
  theme(panel.background = element_blank(),
                    axis.line = element_blank(),
                    axis.text = element_blank(),
                    axis.ticks = element_blank(),
                    axis.title = element_blank(),
                    plot.title = element_text(hjust = 0.5, size = 18))+
  ggtitle("Proportion of GHG gases") 
pie 
```

* The average emission per country from 1990 - 2020 was also visualized below 
```{r worldmap, results = 'hide'}
library(rworldmap)
dataAggregate <- aggregate(emissionValue ~ country, emissionData, mean)
colnames(dataAggregate)[colnames(dataAggregate) == "emissionValue"] <- "Average Emission Value [MtCO₂e] per Country from 1990 to 2020"
worldmaps <- joinCountryData2Map(dataAggregate, nameJoinColumn = "country", joinCode = "NAME")
colourPalette <- RColorBrewer::brewer.pal(10, 'Reds')
mapCountryData(worldmaps, 
               nameColumnToPlot = "Average Emission Value [MtCO₂e] per Country from 1990 to 2020",
               catMethod = 'fixedWidth', 
               colourPalette = 'diverging', 
               numCats = 50)
```


#### Carbon stock

This dataset captures the carbon stock per country for selected 9 years (1990,2000,2010,2015,2016,2017,2018,2019,2020)

#### Preprocessing

1. Some columns were converted to a consistent data type\
2. Missing values were handled with the mice library\
3. Years not captured in the dataset were replaced with the mean carbon stock per country\
4. The unit of the carbon stock was tonnes/ha, where ha is the forest size in hectres\
5. Hence carbon stock was multiplied with forest area.
6. Finally, the emission dataset was merged with the carbon stock to perform correlation.

```{r carbon-stock-dataset, results='hide'}
library(mice)
library(data.table)
data <- read.csv("fra2020-carbonStock.csv")
data$X1990 <- as.numeric(data$X1990)
data <- data[which(rowMeans(is.na(data))<0.5), ]
impute_data <- mice(data, m=5, maxit = 5, seed = 100)
clean_data <- complete(impute_data, 2)
clean_data <- group_by(clean_data, country)
clean_data <- mutate(clean_data, dataMean = mean(c(X1990,X2000,X2010,X2015,X2016,X2017,X2018,X2019,X2020)))

clean_data <- cbind(clean_data, replicate (22, clean_data$dataMean),simplify = FALSE)
clean_data <- setnames(clean_data, old = c("...12","...13","...14","...15","...16","...17","...18","...19","...20",
                                           "...21","...22","...23","...24","...25","...26","...27","...28","...29",
                                           "...30","...31","...32","...33"),
                       new = c("X1991","X1992","X1993","X1994","X1995","X1996","X1997","X1998","X1999","X2001","X2002",
                               "X2003","X2004","X2005",
                               "X2006","X2007","X2008","X2009","X2011","X2012","X2013","X2014"), skip_absent = TRUE)
clean_data <- select(clean_data,'country',c("X1990","X1991","X1992","X1993","X1994","X1995","X1996","X1997",
                                            "X1998","X1999","X2001","X2002","X2003","X2004","X2005","X2006",
                                            "X2007","X2008","X2009","X2011","X2012","X2013","X2014","X2015","X2016",
                                            "X2017","X2018","X2019","X2020"))
carbonStockData <- pivot_longer(clean_data, X1990:X2020, names_to = 'year', values_to = 'carbonStockValue')
carbonStockData <-separate(carbonStockData, col=year, into = c("y","year"), sep="X")
carbonStockData$y <- NULL


forestArea <- read_csv("FAOSTAT_data_6-9-2021.csv")
colnames(forestArea)[colnames(forestArea) == "Area"] <- "country"
colnames(forestArea)[colnames(forestArea) == "Value"] <- "Area"
colnames(forestArea)[colnames(forestArea) == "Year"] <- "year"
forestArea <- select(forestArea, c('country', 'year','Area'))

#merging carbonstock dataset with Forest Area dataset
carbonStockData <- merge(carbonStockData, forestArea, by=c("country","year"))
carbonStockData <- mutate(carbonStockData, carbonInTonnes = (carbonStockValue * Area))
```

#### Analysis and Visualization  of carbon stock 

* The trend of carbon stock globally from 1990 to 2018 was shown below\

```{r merged-data-for-correlation, results = 'hide'}
mergedData <- merge(carbonStockData, emissionData, by=c("country","year"))%>%
  select(c('year', 'country','carbonInTonnes','emissionValue'))%>%
  drop_na()%>%
  group_by(year)%>%
  summarize(carbonStockSum = mean(carbonInTonnes), emissionSum = mean(emissionValue))%>%
  unique()

```

* Comparatively, the trend of the emitted GHG from 1990 to 2018 was also shown \
```{r trend-of-carbon-stock, echo=FALSE, results = 'hide'}
mergedData%>%
  ggplot(aes(year, carbonStockSum, group=1)) + geom_line() + 
  geom_point(aes(colour = "red")) + 
  scale_x_discrete(guide = guide_axis(check.overlap = TRUE))+
  scale_y_continuous(labels = scales::comma) + 
  labs(title="Carbon Stock trend from 1990 to 2018", x = "Year", y = "Carbon Stock [1000 tonnes]") +
  theme(legend.position = "none")
```
* Comparatively, the trend of the emitted GHG from 1990 to 2018 was also shown \
```{r trend-of-carbon-emitted, echo=FALSE, results = 'hide'}
mergedData%>%
  ggplot(aes(year, emissionSum, group=1)) + geom_line() + 
  geom_point(aes(colour = "red")) + 
  scale_x_discrete(guide = guide_axis(check.overlap = TRUE))+
  scale_y_continuous(labels = scales::comma) + 
  labs(title="Trend of emitted GHG from 1990 to 2018", x = "Year", y = "GHG emitted [1000 tonnes]") +
  theme(legend.position = "none")
  #theme_bw()
```

* Here we visualized the countries with the largest carbon stock
```{r countries-with the-highest-carbon-stock-in-forests, echo=FALSE, results = 'hide'}
carbonStockData %>%
  drop_na()%>%
  group_by(country)%>%
  summarise(avgCarbon = mean(carbonInTonnes))%>%
  arrange(desc(avgCarbon))%>%
  top_n(20)%>%
  ggplot(aes(x=avgCarbon, y=reorder(country, avgCarbon))) + geom_col(fill='limegreen') + labs(title='Largest carbon stock in forests (1990 - 2020)', x = 'Average Carbon Stock [1000 tonnes]', y = 'Country') + scale_color_viridis_c(option = "inferno") + theme(legend.position = "none")+scale_x_continuous(labels = scales::comma)
  
```


#### Correlation proper
We seek to answer the correlation question here, we start by comparing both variables per year.

* Correlation plot
```{r correlation-plots, echo=FALSE, results = 'hide'}
mergedData%>%
  ggplot(aes(x=emissionSum, y=carbonStockSum)) + geom_point(color="red") +
  labs(x="GHG emissions [1000 tonnes]", y = "Sum of carbon stock in forests [1000 tonnes]", title="GHG emissions against carbon stock in forests, per year") +
  geom_smooth(method = 'lm', fill="darkolivegreen2") +
  scale_y_continuous(labels = scales::comma)
  
```

#### Correlation result

```{r correlation, echo=FALSE}
x <- cor(x=mergedData$emissionSum, y=mergedData$carbonStockSum, use = "everything", method = "kendall")
paste("Kendall = ", x)

y <- cor(x=mergedData$emissionSum, y=mergedData$carbonStockSum, use = "everything", method = "spearman")
paste("Spearman = ", y)

z <- cor(x=mergedData$emissionSum, y=mergedData$carbonStockSum, use = "everything", method = "pearson")
paste("Pearson = ", z)
```
**Interpretation of the correlation coefficient;** both variables are negatively correlated using all correlation methods. Most likely, if the emission increases, the carbon stock decreases. However, this relationship can not be ascertained using correlation because correlation does not necessarily imply causation.

Also, the absolute value of approximately 1.0 depicts perfectly linear correlation between both variables.


**Question 2: How much gas will be absorbed if forest area increases**

#### Introduction\
Here, the objective of our analysis is to investigate how much GHG will be absorbed if forest area is increased. To do this, we use the carbon stock and forest area datasets already loaded.


#### Analysis and Visualization

* Comparison between absorbed carbon and forest area
```{r forest-area-against-absorbed-carbon, echo=FALSE, results='hide'}
library(mice)
data <- read_csv("fra2020-carbonStock.csv")
forestArea <- read_csv("FAOSTAT_data_6-9-2021.csv")
colnames(forestArea)[colnames(forestArea) == "Area"] <- "country"
colnames(forestArea)[colnames(forestArea) == "Value"] <- "Area"

data <- data%>%
 pivot_longer(c("1990","2000","2010","2015","2016","2017","2018","2019","2020"), names_to = 'Year', values_to = 'carbonStock')%>%
 merge(forestArea, by=c("country","Year"))%>%
 select(c("country","Year","Area","carbonStock"))%>%
 mice(m=5, maxit = 5, seed = 100)%>%
 complete(2)%>%
 group_by(Year)%>%summarise(totalArea = sum(Area), totalCarbonAbsorbed = sum(carbonStock))
data
```

```{r regression-plots, echo=FALSE}
df_reg_lines <- expand_grid(intercept = 82:88, slope = seq(0.4, 0.6, 0.1))
data %>%
  ggplot(aes(y = totalArea, x = totalCarbonAbsorbed)) + geom_point(color="red1") + geom_smooth(method = "lm", size = 1, fill="deepskyblue2") + 
 labs(y = "Forest Area [1000ha]", x = "Carbon Absorbed [MtCO2]", title = "Comparison between absorbed carbon and forest area")
```
The result below was gotten after using linear regression \

#### Result
```{r linear-regression, echo=FALSE}
library(tidymodels)
linear_reg() %>%
 set_engine("lm") %>%
 fit(formula = totalCarbonAbsorbed ~ totalArea, data = data) %>%
 tidy()
```

* Carbon_absorbed = 392	+ 0.00243 * totalArea \

* For a unit increase in total forest area, the volume of carbon absorbed should increase by 0.00243 \

* If there are no forests ie totalArea = 0, the volume of carbon absorbed will be 392.\

* Therefore, a unit increase in forest area, results in a decrease in the quantity of emitted CO2 by 0.00243

