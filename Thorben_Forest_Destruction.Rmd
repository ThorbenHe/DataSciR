---
title: "Forest Destruction"
author: "Thorben Hebbelmann"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE, cache = TRUE)

library(tidyverse)
library(tidymodels)
library(plotly)
library(countrycode)
library(kableExtra)

options(scipen=999)
```

```{r loading_data, include=FALSE}
fra_data_tmp <- tibble(read_csv("FRA_2020_data/Annual_2021_05_05.csv"))
temperature_data_tmp <- tibble(read_csv("Environment_Temperature_change_E_All_Data_(Normalized)/Environment_Temperature_change_E_All_Data_(Normalized).csv"))
```

The next part of our project is about forest destruction and tries to answer the following questions:

* What were the main causes of forest destruction?
    + Which countries were affected the most?
    + How much forest was destroyed by each of these causes?
* Is there a correlation between rising temperatures and wildfires?
* Prediction of where and when wildfires are likely to occur.

### Overview and Preprocessing of the available data

Our first data set is about forest disturbances (e.g. fire, weather) for the period 2000-2017:  
[FAO. 2020. Global Forest Resources Assessment 2020](https://fra-data.fao.org/WO/fra2020/home/) - data set 2

```{r fra_overview}
glimpse(fra_data_tmp)
```

First we remove everything that we won't need and make column names (of columns that we will later need) more readable: 

* The 'regions' column gets exchanged by a continent column which provides more intuitive information. 
* The 'iso3' column doesn't provide any further information.
* The name and continent column are changed to factor variables.

We also replace missing values with 0, because there is now safe way to impute these values. However this implies that our results for this part of the project are probably an underestimation.

```{r fra_data_processing}
fra_data <- fra_data_tmp %>%
  mutate(continent = countrycode(sourcevar = iso3, origin = "iso3c", destination = "continent"),
         across(everything(), ~ replace_na(.x, 0)),
         name = factor(name),
         continent = factor(continent)) %>% 
  select(-c(iso3, regions)) %>% 
  rename(Insects = `5a_insect`, 
         Diseases = `5a_diseases`, 
         Weather = `5a_weather`, 
         Others = `5a_other`,
         Fire = `5b_fire_forest`) %>% 
  #rename_with(str_to_title) %>% 
  relocate(name, continent, year, Insects, Diseases, Weather, Others, Fire)

fra_data
# Use maybe kable table
# fra_data %>% 
#  kable(caption = "Data on forest desturbances") %>% 
#  scroll_box(width = "100%", height = "200px")
```


The second data set we use is about mean surface temperature changes for the period 1961-2020:  
[FAO. 2021. FAOSTAT Temperature Change Dataset](http://www.fao.org/faostat/en/#data/ET) 

```{r temp_overview}
glimpse(temperature_data_tmp %>% select(-Unit)) # Markdown cannot handle the Unit entries.
```

Again we remove everything that we won't need: 

* All 'Code'-columns: Add no information.
* All years that are not in 2000-2017: No forest data for these years.
* The Unit column: it's always °C.
* All missing values (Flags != "Fc") and afterwards the flag column.

```{r temp_data_processing}
temperature_data <- temperature_data_tmp %>% 
  filter(Year %in% 2000:2017,
         Flag == "Fc") %>% 
  select(-c(contains("Code"), Flag, Unit))
# Use maybe kable table
temperature_data
```
### Results

After preprocessing we can start answering the questions.  
For the first two questions we decided to look at a global scale and for the country Germany.  
For the third question we decided to look at a global scale and for the continent Europe.

Note: In our interactive shiny website you can pick the country / continent of your interest.

#### What were the main causes of forest destruction?

```{r overview}
plot_yearly_forest_destruction_by_region <- function(region = 'Global') {
  fra_data %>% 
    filter(name == region | continent == region | region == 'Global') %>% 
    group_by(year) %>% 
    summarise(Insects = sum(Insects, na.rm = TRUE),
              Diseases = sum(Diseases, na.rm = TRUE),
              Weather = sum(Weather, na.rm = TRUE),
              Others = sum(Others, na.rm = TRUE),
              Fire = sum(Fire, na.rm = TRUE)) %>% 
    pivot_longer(cols = c(Insects, Diseases, Weather, Others, Fire), names_to = "cause", values_to = "area") %>% 
    ggplot(aes(x=year, y=area, fill=reorder(cause,area))) +
    geom_area() +
    scale_x_continuous(breaks = c(2000, 2005, 2010, 2015, 2017)) +
    scale_y_continuous(labels = scales::comma) +
    scale_fill_manual(values = c(Weather = "#2b83ba", Others = "#ffffbf", Fire = "#d7191c",
                                 Diseases = "#fdae61", Insects = "#abdda4")) +
    labs(title = "Forest destruction per year and cause",
         subtitle = glue::glue("Region: {region} - Time period: 2000 - 2017"),
         x = "Year",
         y = "Forest Area [ha]",
         fill = "Cause") +
    theme_minimal()
}

plot_yearly_forest_destruction_by_region()
plot_yearly_forest_destruction_by_region('Germany')
```
  
Note: the peak in the second plot was caused by the heat wave in 2003.  

### How much forest was destroyed by each of these causes?

```{r area_by_cause, echo=FALSE}

plot_total_forest_destruction_by_region <- function(region = 'Global') {
  disturbance_data <- fra_data %>% 
    filter(name == region | region == 'Global') %>% 
    select(-`5b_fire_land`) %>% 
    mutate(Insects = sum(Insects, na.rm = TRUE)) %>% 
    mutate(Diseases = sum(Diseases, na.rm = TRUE)) %>% 
    mutate(Weather = sum(Weather, na.rm = TRUE)) %>% 
    mutate(Others = sum(Others, na.rm = TRUE)) %>% 
    mutate(Fire = sum(Fire, na.rm = TRUE)) %>% 
    pivot_longer(cols = c(Insects, Diseases, Weather, Others, Fire), names_to = "cause", values_to = "area") %>% 
    slice(1:5) %>% 
    select(cause, area)
  
  bar_plot <- ggplot(disturbance_data, aes(x = reorder(cause,desc(area)), y = area, fill = cause)) + 
    geom_col() +
    labs(title = "Total forest destruction by cause",
         subtitle = glue::glue("Region: {region} - Time period: 2000 - 2017"),
         x = "",
         y = "Forest Area [ha]") +
    scale_y_continuous(labels = scales::comma) +
    scale_fill_manual(values = c(Weather = "#2b83ba", Others = "#ffffbf", Fire = "#d7191c",
                                 Diseases = "#fdae61", Insects = "#abdda4")) +
    theme_minimal() +
    guides(fill = FALSE)
  
  pie_plot <- ggplot(disturbance_data, aes(x="", y = area, fill = reorder(cause, desc(area)))) + 
    geom_bar(stat="identity", width=1) +
    coord_polar("y") +
    scale_fill_manual(values = c(Weather = "#2b83ba", Others = "#ffffbf", Fire = "#d7191c",
                                 Diseases = "#fdae61", Insects = "#abdda4")) +  
    labs(x = "",
         y = "Forest Area [ha]",
         fill = "Cause") +
    theme_void()
  
  library(patchwork)
  bar_plot + pie_plot
}

plot_total_forest_destruction_by_region()
plot_total_forest_destruction_by_region('Germany')
```

#### Which countries were affected the most?

```{r most_affected}
plot_highest_forest_destruction <- function(cont = 'Global', number = 15, cs = 'All') {
  
  fra_data %>% 
    filter(continent == cont | cont == 'Global') %>% 
    select(name, c(Insects, Diseases, Weather, Others, Fire)) %>% 
    group_by(name) %>% 
    summarise(Insects = sum(Insects, na.rm = TRUE),
              Diseases = sum(Diseases, na.rm = TRUE),
              Weather = sum(Weather, na.rm = TRUE),
              Others = sum(Others, na.rm = TRUE),
              Fire = sum(Fire, na.rm = TRUE)) %>% 
    ungroup() %>% 
    pivot_longer(cols = c(Insects, Diseases, Weather, Others, Fire), names_to = "cause", values_to = "area") %>% 
    filter(cause == cs | cs == 'All') %>% 
    group_by(name) %>% 
    mutate(total = sum(area, na.rm = TRUE)) %>% 
    ungroup() %>% 
    arrange(desc(total)) %>% 
    slice(1:(5*number)) %>% 
    ggplot(aes(x=area, y=reorder(name, area), fill=reorder(cause, area))) +
    geom_col() +
    scale_x_continuous(labels = scales::comma) +
    scale_fill_manual(values = c(Weather = "#2b83ba", Others = "#ffffbf", Fire = "#d7191c",
                                 Diseases = "#fdae61", Insects = "#abdda4"), labels = c("Diseases","Insects","Others","Weather","Fire")) + 
    labs(title = glue::glue("The {number} Countries with the highest forest destruction"),
         subtitle = glue::glue("Region: {cont} - Time period: 2000 - 2017"),
         x = "Forest Area [ha]",
         y = "Country",
         fill = "Cause") +
    theme_minimal()
  
}

plot_highest_forest_destruction()
# ggplotly(plot_highest_forest_destruction())
plot_highest_forest_destruction("Europe", 5, "All")
```

#### Is there a correlation between rising temperatures and wildfires?

##### Overview:

```{r fire_temp_corr_preprocessing, include=FALSE}
global_yearly_tc <- temperature_data %>% 
  filter(Area == 'World', 
         Element == 'Temperature change', 
         Months == 'Meteorological year'
  ) %>% 
  select(Year, Value) %>% 
  rename(year = Year, temp_increase = Value)

global_yearly_tc

# Preprocessing of FRA data missing
fra_tc_global <- inner_join(fra_data, global_yearly_tc, by=c("year"))

fra_tc_global
```

```{r todo, include=FALSE}
local_yearly_tc <- temperature_data %>% 
  filter(Element == 'Temperature change', 
         Months == 'Meteorological year') %>% 
  select(Area, Year, Value) %>% 
  rename(name = Area, year = Year, temp_increase = Value)

fra_tc_local <- inner_join(fra_data, local_yearly_tc, by=c("name", "year"))

fra_tc_local
```

```{r fire_temp_corr_plot3}
fra_tc_global %>% 
  group_by(year) %>% 
  summarise(fire = sum(Fire, na.rm = TRUE), 
            temp = mean(temp_increase)) %>% 
  ggplot(aes(x=year, y=fire, fill = temp)) +
  geom_col() + 
  scale_y_continuous(labels = scales::comma) +
  scale_fill_viridis_c(option = "inferno") +
  labs(title = "Global area of wildfires per year",
       subtitle = "Time period: 2000 - 2017",
       x = "Year",
       y = "Wildfire Area [ha]",
       fill = "Temperature increase in C°") +
  theme_minimal()
```

```{r}
fra_tc_local %>% 
  filter(!is.na(Fire)) %>% 
  ggplot(aes(y=Fire, x=temp_increase )) +
  geom_point(aes(color = continent)) +
  labs(title = "Global area of wildfires per year",
       subtitle = "Time period: 2000 - 2017",
       x = "Year",
       y = "Wildfire Area [ha]",
       fill = "Temperature increase in C°") +
  theme_minimal()
```

First we compare global yearly temperature changes to global forest area destructed by wildfires.

```{r fire_temp_corr_plot}
# Forest
fra_tc_global %>% 
  group_by(year) %>% 
  summarise(fire = sum(Fire, na.rm = TRUE), 
            temp = temp_increase) %>% 
  ggplot(aes(x=temp, y=fire)) +
  geom_line() + 
  geom_point() +
  labs(
    title = "Relationship between global temperature increase and global wildfire area",
    subtitle = "Time period: 2000 - 2017",
    x = "Temperature Increase [C°]",
    y = "Wildfire Area [ha]" 
  ) +
  theme_minimal()

# Land
fra_tc_global %>% 
  group_by(year) %>% 
  summarise(fire = sum(`5b_fire_land`, na.rm = TRUE), 
            temp = temp_increase) %>% 
  ggplot(aes(x=temp, y=fire)) +
  geom_line() + 
  geom_point() +
  labs(
    title = "Relationship between global temperature increase and gloabl fire area",
    subtitle = "Time period: 2000 - 2017",
    x = "Temperature Increase [C°]",
    y = "Fire Area [ha]" 
  ) +
  theme_minimal()

# TODO: Change argumentation chain 
# Keep in mind that land includes forest!!!
```

There is no linear correlation visible for both land and forest fires and rising temperatures.

Now we compare global yearly temperature changes to the global count of wildfires.

```{r fire_temp_corr_plot2}
# TODO: Summarize / Ungroup refactoring?
# Forest
fra_tc_global %>% 
  mutate(Fire = case_when(
    is.na(Fire) | Fire == 0 ~ FALSE,
    TRUE ~ TRUE
  )) %>% 
  group_by(year) %>% 
  summarise(fire = sum(Fire, rm.na = TRUE), temp = mean(temp_increase)) %>% 
  ungroup() %>% 
  ggplot(aes(x=temp, y=fire)) +
  geom_line() + 
  geom_point() +
  labs(
    title = "Relationship between global temperature increase and the global amount of wildfires",
    subtitle = "Time period: 2000 - 2017",
    x = "Temperature Increase [C°]",
    y = "Wildfire Area [ha]" 
  ) +
  theme_minimal()

# Land
fra_tc_global %>% 
  mutate(`5b_fire_land` = case_when(
    is.na(`5b_fire_land`) | Fire == 0 ~ FALSE,
    TRUE ~ TRUE
  )) %>% 
  group_by(year) %>% 
  summarise(fire = sum(`5b_fire_land`, rm.na = TRUE), 
            temp = temp_increase) %>% 
  ggplot(aes(x=temp, y=fire)) +
  geom_line() + 
  geom_point() +
  labs(
    title = "Relationship between global temperature increase and the global amount of fires",
    subtitle = "Time period: 2000 - 2017",
    x = "Temperature Increase [C°]",
    y = "Wildfire Area [ha]" 
  ) +
  theme_minimal()
```

Again there is no linear correlation visible for both land and forest fires and rising temperatures.

We need a way to quantify these results: Use Predicitive Power Score

```{r}
# Code from ex-6-codealong.Rmd
# TODO: Change design of plots
library(ppsr)

pps1 <- score_df(fra_tc_global %>% 
                   group_by(year) %>% 
                   summarise(Wildfires = sum(Fire, na.rm = TRUE), 
                             Temperature = mean(temp_increase)) %>% ungroup() %>% 
                   select(Temperature, Wildfires))

ggplot(pps1, aes(x, y)) +
  geom_tile(aes(fill = pps)) +
  geom_text(aes(label = round(pps, 2), color = pps > 0.8), size = 12 / .pt) +
  scale_fill_distiller(palette = "Greys", direction = 1) +
  scale_color_manual(values = c("black", "white")) +
  guides(color = FALSE) +
  labs(
    x = NULL, y = NULL, fill = "Predictive\nPower\nScore", title = "PPS matrix for global wildfire area",
    subtitle = "A value represents the predictive power that the\nx variable has on the y variable."
  ) +
  coord_equal() +
  theme(axis.text.x = element_text(angle = 325, hjust = 0, vjust = 0)) +
  theme(plot.subtitle = element_text(size = rel(1))) + 
  theme_minimal()


pps2 <- score_df(fra_tc_global %>% 
                   mutate(Fire = case_when(
                     is.na(Fire) | Fire == 0 ~ FALSE,
                     TRUE ~ TRUE
                   )) %>% 
                   group_by(year) %>% 
                   summarise(Wildfires = sum(Fire, na.rm = TRUE), 
                             Temperature = mean(temp_increase)) %>% 
                   ungroup() %>% 
                   select(Temperature, Wildfires))

ggplot(pps2, aes(x, y)) +
  geom_tile(aes(fill = pps)) +
  geom_text(aes(label = round(pps, 2), color = pps > 0.8), size = 12 / .pt) +
  scale_fill_distiller(palette = "Greys", direction = 1) +
  scale_color_manual(values = c("black", "white")) +
  guides(color = FALSE) +
  labs(
    x = NULL, y = NULL, fill = "Predictive\nPower\nScore", title = "PPS matrix for global wildfire count",
    subtitle = "A value represents the predictive power that the\nx variable has on the y variable."
  ) +
  coord_equal() +
  theme(axis.text.x = element_text(angle = 325, hjust = 0, vjust = 0)) +
  theme(plot.subtitle = element_text(size = rel(1))) +
  theme_minimal()
```

There is clearly no correlation recognizable in our data between temperature increase and wildfires.

#### Prediction of where and when wildfires are likely to occur.

First we look at the available data and see which columns might help us to make a prediction.

```{r wildfire_prediction}
temperature_data
fra_data

temp <- temperature_data %>% 
  filter(Element == 'Temperature change', 
         Months == 'Meteorological year') %>% 
  select(Area, Year, Value) %>% 
  rename(name = Area, year = Year, temp_increase = Value)

# Interpretation of NA's as No Wild Fire, because of the structur of the entries for this column
fra <- fra_data %>% 
  mutate(Fire = case_when(
    Fire == 0 ~ "No",
    TRUE ~ "Yes"
  )) %>% 
  mutate(Fire = factor(Fire)) %>% 
  rename(wildfire = Fire)

fra_tc_data <- inner_join(fra, temp, by=c("name", "year"))

fra_tc_data[is.na(fra_tc_data)] <- 0
fra_tc_data
```

We got roughly 3800 samples for the prediction

```{r prepare_data}
set.seed(123)

# Specify data splits 
init_split <- initial_split(fra_tc_data, strata = wildfire)
wf_training <- training(init_split)
wf_testing <- testing(init_split)

# 5-fold cross validation
wf_cv <- vfold_cv(wf_training, v = 5)
```

```{r model_specs}
# Logistic regression
lr_model_spec <- logistic_reg() %>%
  set_engine("glm") %>%
  set_mode("classification")

# Decision Tree
dt_model_spec <- decision_tree() %>% 
  set_engine("rpart") %>% 
  set_mode("classification")
```

```{r model_validation}
# Fit models on cv training data
wf <- workflow() %>%
  add_formula(wildfire ~ temp_increase) %>% 
  add_model(lr_model_spec)

lr_results_1 <- wf %>% 
  fit_resamples(wf_cv) %>% 
  collect_metrics()

wf <- wf %>% update_model(dt_model_spec)

dt_results_1 <- wf %>% 
  fit_resamples(wf_cv) %>% 
  collect_metrics()

lr_results_1
dt_results_1

# Decision Tree has a better performance
```

```{r model_validation_2}
# Next step: find optimal formula

wf <- wf %>% update_formula(wildfire ~ name + continent + temp_increase + boreal + temperate+ tropical+ subtropical + Insects + Diseases + Weather + Others
)

dt_results_2 <- wf %>% 
  fit_resamples(wf_cv) %>% 
  collect_metrics()

dt_results_2
```

```{r model_evaluation}
dt_fit <- fit(dt_model_spec, wildfire ~ name + continent + temp_increase + boreal + temperate+ tropical+ subtropical + Insects + Diseases + Weather + Others, wf_training)
rpart.plot::rpart.plot(dt_fit$fit)

predict(dt_fit, new_data = wf_testing) %>%
  mutate(truth = wf_testing$wildfire) %>%
  accuracy(estimate = .pred_class, truth = truth)

# prediction of when a wildfire occurs sees to be impractical because the most / only important factor is the country
# remove year - doesn't make any sence to use it predict upcoming wildfires

#predict(fit, new_data = wf_testing) %>%
# mutate(truth = wf_testing$wildfire) %>%
#accuracy(estimate = .pred_class, truth = truth)

#predict(fit2, new_data = wf_testing) %>%
# mutate(truth = wf_testing$wildfire) %>%
#accuracy(estimate = .pred_class, truth = truth)
#rpart.plot::rpart.plot(results4$)
```

```{r}
dt_fit <- fit(dt_model_spec, wildfire ~ temp_increase + boreal + temperate + tropical+ subtropical + Insects + Diseases + Weather + Others, wf_training)
rpart.plot::rpart.plot(dt_fit$fit)

predict(dt_fit, new_data = wf_testing) %>%
  mutate(truth = wf_testing$wildfire) %>%
  accuracy(estimate = .pred_class, truth = truth)
```
